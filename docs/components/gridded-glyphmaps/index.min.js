function ascending$1(t,e){return null==t||null==e?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function descending(t,e){return null==t||null==e?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function bisector(t){let e,n,r;function o(t,r,o=0,i=t.length){if(o<i){if(0!==e(r,r))return i;do{const e=o+i>>>1;n(t[e],r)<0?o=e+1:i=e}while(o<i)}return o}return 2!==t.length?(e=ascending$1,n=(e,n)=>ascending$1(t(e),n),r=(e,n)=>t(e)-n):(e=t===ascending$1||t===descending?t:zero$1,n=t,r=t),{left:o,center:function(t,e,n=0,i=t.length){const a=o(t,e,n,i-1);return a>n&&r(t[a-1],e)>-r(t[a],e)?a-1:a},right:function(t,r,o=0,i=t.length){if(o<i){if(0!==e(r,r))return i;do{const e=o+i>>>1;n(t[e],r)<=0?o=e+1:i=e}while(o<i)}return o}}}function zero$1(){return 0}function number$1(t){return null===t?NaN:+t}function*numbers(t,e){if(void 0===e)for(let e of t)null!=e&&(e=+e)>=e&&(yield e);else{let n=-1;for(let r of t)null!=(r=e(r,++n,t))&&(r=+r)>=r&&(yield r)}}const ascendingBisect=bisector(ascending$1),bisectRight=ascendingBisect.right;bisector(number$1).center;var bisect=bisectRight;const blur2=Blur2(blurf);function Blur2(t){return function(e,n,r=n){if(!((n=+n)>=0))throw new RangeError("invalid rx");if(!((r=+r)>=0))throw new RangeError("invalid ry");let{data:o,width:i,height:a}=e;if(!((i=Math.floor(i))>=0))throw new RangeError("invalid width");if(!((a=Math.floor(void 0!==a?a:o.length/i))>=0))throw new RangeError("invalid height");if(!i||!a||!n&&!r)return e;const l=n&&t(n),s=r&&t(r),c=o.slice();return l&&s?(blurh(l,c,o,i,a),blurh(l,o,c,i,a),blurh(l,c,o,i,a),blurv(s,o,c,i,a),blurv(s,c,o,i,a),blurv(s,o,c,i,a)):l?(blurh(l,o,c,i,a),blurh(l,c,o,i,a),blurh(l,o,c,i,a)):s&&(blurv(s,o,c,i,a),blurv(s,c,o,i,a),blurv(s,o,c,i,a)),e}}function blurh(t,e,n,r,o){for(let i=0,a=r*o;i<a;)t(e,n,i,i+=r,1)}function blurv(t,e,n,r,o){for(let i=0,a=r*o;i<r;++i)t(e,n,i,i+a,r)}function blurf(t){const e=Math.floor(t);if(e===t)return bluri(t);const n=t-e,r=2*t+1;return(t,o,i,a,l)=>{if(!((a-=l)>=i))return;let s=e*o[i];const c=l*e,u=c+l;for(let t=i,e=i+c;t<e;t+=l)s+=o[Math.min(a,t)];for(let e=i,f=a;e<=f;e+=l)s+=o[Math.min(a,e+c)],t[e]=(s+n*(o[Math.max(i,e-u)]+o[Math.min(a,e+u)]))/r,s-=o[Math.max(i,e-c)]}}function bluri(t){const e=2*t+1;return(n,r,o,i,a)=>{if(!((i-=a)>=o))return;let l=t*r[o];const s=a*t;for(let t=o,e=o+s;t<e;t+=a)l+=r[Math.min(i,t)];for(let t=o,c=i;t<=c;t+=a)l+=r[Math.min(i,t+s)],n[t]=l/e,l-=r[Math.max(o,t-s)]}}function extent(t,e){let n,r;if(void 0===e)for(const e of t)null!=e&&(void 0===n?e>=e&&(n=r=e):(n>e&&(n=e),r<e&&(r=e)));else{let o=-1;for(let i of t)null!=(i=e(i,++o,t))&&(void 0===n?i>=i&&(n=r=i):(n>i&&(n=i),r<i&&(r=i)))}return[n,r]}function compareDefined(t=ascending$1){if(t===ascending$1)return ascendingDefined;if("function"!=typeof t)throw new TypeError("compare is not a function");return(e,n)=>{const r=t(e,n);return r||0===r?r:(0===t(n,n))-(0===t(e,e))}}function ascendingDefined(t,e){return(null==t||!(t>=t))-(null==e||!(e>=e))||(t<e?-1:t>e?1:0)}const e10=Math.sqrt(50),e5=Math.sqrt(10),e2=Math.sqrt(2);function tickSpec(t,e,n){const r=(e-t)/Math.max(0,n),o=Math.floor(Math.log10(r)),i=r/Math.pow(10,o),a=i>=e10?10:i>=e5?5:i>=e2?2:1;let l,s,c;return o<0?(c=Math.pow(10,-o)/a,l=Math.round(t*c),s=Math.round(e*c),l/c<t&&++l,s/c>e&&--s,c=-c):(c=Math.pow(10,o)*a,l=Math.round(t/c),s=Math.round(e/c),l*c<t&&++l,s*c>e&&--s),s<l&&.5<=n&&n<2?tickSpec(t,e,2*n):[l,s,c]}function ticks(t,e,n){if(!((n=+n)>0))return[];if((t=+t)===(e=+e))return[t];const r=e<t,[o,i,a]=r?tickSpec(e,t,n):tickSpec(t,e,n);if(!(i>=o))return[];const l=i-o+1,s=new Array(l);if(r)if(a<0)for(let t=0;t<l;++t)s[t]=(i-t)/-a;else for(let t=0;t<l;++t)s[t]=(i-t)*a;else if(a<0)for(let t=0;t<l;++t)s[t]=(o+t)/-a;else for(let t=0;t<l;++t)s[t]=(o+t)*a;return s}function tickIncrement(t,e,n){return tickSpec(t=+t,e=+e,n=+n)[2]}function tickStep(t,e,n){n=+n;const r=(e=+e)<(t=+t),o=r?tickIncrement(e,t,n):tickIncrement(t,e,n);return(r?-1:1)*(o<0?1/-o:o)}function max(t,e){let n;if(void 0===e)for(const e of t)null!=e&&(n<e||void 0===n&&e>=e)&&(n=e);else{let r=-1;for(let o of t)null!=(o=e(o,++r,t))&&(n<o||void 0===n&&o>=o)&&(n=o)}return n}function min(t,e){let n;if(void 0===e)for(const e of t)null!=e&&(n>e||void 0===n&&e>=e)&&(n=e);else{let r=-1;for(let o of t)null!=(o=e(o,++r,t))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}function quickselect(t,e,n=0,r=1/0,o){if(e=Math.floor(e),n=Math.floor(Math.max(0,n)),r=Math.floor(Math.min(t.length-1,r)),!(n<=e&&e<=r))return t;for(o=void 0===o?ascendingDefined:compareDefined(o);r>n;){if(r-n>600){const i=r-n+1,a=e-n+1,l=Math.log(i),s=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*s*(i-s)/i)*(a-i/2<0?-1:1);quickselect(t,e,Math.max(n,Math.floor(e-a*s/i+c)),Math.min(r,Math.floor(e+(i-a)*s/i+c)),o)}const i=t[e];let a=n,l=r;for(swap(t,n,e),o(t[r],i)>0&&swap(t,n,r);a<l;){for(swap(t,a,l),++a,--l;o(t[a],i)<0;)++a;for(;o(t[l],i)>0;)--l}0===o(t[n],i)?swap(t,n,l):(++l,swap(t,l,r)),l<=e&&(n=l+1),e<=l&&(r=l-1)}return t}function swap(t,e,n){const r=t[e];t[e]=t[n],t[n]=r}function quantile(t,e,n){if((r=(t=Float64Array.from(numbers(t,n))).length)&&!isNaN(e=+e)){if(e<=0||r<2)return min(t);if(e>=1)return max(t);var r,o=(r-1)*e,i=Math.floor(o),a=max(quickselect(t,i).subarray(0,i+1));return a+(min(t.subarray(i+1))-a)*(o-i)}}var noop={value:()=>{}};function dispatch(){for(var t,e=0,n=arguments.length,r={};e<n;++e){if(!(t=arguments[e]+"")||t in r||/[\s.]/.test(t))throw new Error("illegal type: "+t);r[t]=[]}return new Dispatch(r)}function Dispatch(t){this._=t}function parseTypenames$1(t,e){return t.trim().split(/^|\s+/).map((function(t){var n="",r=t.indexOf(".");if(r>=0&&(n=t.slice(r+1),t=t.slice(0,r)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:n}}))}function get$1(t,e){for(var n,r=0,o=t.length;r<o;++r)if((n=t[r]).name===e)return n.value}function set$1(t,e,n){for(var r=0,o=t.length;r<o;++r)if(t[r].name===e){t[r]=noop,t=t.slice(0,r).concat(t.slice(r+1));break}return null!=n&&t.push({name:e,value:n}),t}Dispatch.prototype=dispatch.prototype={constructor:Dispatch,on:function(t,e){var n,r=this._,o=parseTypenames$1(t+"",r),i=-1,a=o.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++i<a;)if(n=(t=o[i]).type)r[n]=set$1(r[n],t.name,e);else if(null==e)for(n in r)r[n]=set$1(r[n],t.name,null);return this}for(;++i<a;)if((n=(t=o[i]).type)&&(n=get$1(r[n],t.name)))return n},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new Dispatch(t)},call:function(t,e){if((n=arguments.length-2)>0)for(var n,r,o=new Array(n),i=0;i<n;++i)o[i]=arguments[i+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(i=0,n=(r=this._[t]).length;i<n;++i)r[i].value.apply(e,o)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],o=0,i=r.length;o<i;++o)r[o].value.apply(e,n)}};var xhtml="http://www.w3.org/1999/xhtml",namespaces={svg:"http://www.w3.org/2000/svg",xhtml:xhtml,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function namespace(t){var e=t+="",n=e.indexOf(":");return n>=0&&"xmlns"!==(e=t.slice(0,n))&&(t=t.slice(n+1)),namespaces.hasOwnProperty(e)?{space:namespaces[e],local:t}:t}function creatorInherit(t){return function(){var e=this.ownerDocument,n=this.namespaceURI;return n===xhtml&&e.documentElement.namespaceURI===xhtml?e.createElement(t):e.createElementNS(n,t)}}function creatorFixed(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function creator(t){var e=namespace(t);return(e.local?creatorFixed:creatorInherit)(e)}function none(){}function selector(t){return null==t?none:function(){return this.querySelector(t)}}function selection_select(t){"function"!=typeof t&&(t=selector(t));for(var e=this._groups,n=e.length,r=new Array(n),o=0;o<n;++o)for(var i,a,l=e[o],s=l.length,c=r[o]=new Array(s),u=0;u<s;++u)(i=l[u])&&(a=t.call(i,i.__data__,u,l))&&("__data__"in i&&(a.__data__=i.__data__),c[u]=a);return new Selection$1(r,this._parents)}function array(t){return null==t?[]:Array.isArray(t)?t:Array.from(t)}function empty(){return[]}function selectorAll(t){return null==t?empty:function(){return this.querySelectorAll(t)}}function arrayAll(t){return function(){return array(t.apply(this,arguments))}}function selection_selectAll(t){t="function"==typeof t?arrayAll(t):selectorAll(t);for(var e=this._groups,n=e.length,r=[],o=[],i=0;i<n;++i)for(var a,l=e[i],s=l.length,c=0;c<s;++c)(a=l[c])&&(r.push(t.call(a,a.__data__,c,l)),o.push(a));return new Selection$1(r,o)}function matcher(t){return function(){return this.matches(t)}}function childMatcher(t){return function(e){return e.matches(t)}}var find=Array.prototype.find;function childFind(t){return function(){return find.call(this.children,t)}}function childFirst(){return this.firstElementChild}function selection_selectChild(t){return this.select(null==t?childFirst:childFind("function"==typeof t?t:childMatcher(t)))}var filter=Array.prototype.filter;function children(){return Array.from(this.children)}function childrenFilter(t){return function(){return filter.call(this.children,t)}}function selection_selectChildren(t){return this.selectAll(null==t?children:childrenFilter("function"==typeof t?t:childMatcher(t)))}function selection_filter(t){"function"!=typeof t&&(t=matcher(t));for(var e=this._groups,n=e.length,r=new Array(n),o=0;o<n;++o)for(var i,a=e[o],l=a.length,s=r[o]=[],c=0;c<l;++c)(i=a[c])&&t.call(i,i.__data__,c,a)&&s.push(i);return new Selection$1(r,this._parents)}function sparse(t){return new Array(t.length)}function selection_enter(){return new Selection$1(this._enter||this._groups.map(sparse),this._parents)}function EnterNode(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}function constant$2(t){return function(){return t}}function bindIndex(t,e,n,r,o,i){for(var a,l=0,s=e.length,c=i.length;l<c;++l)(a=e[l])?(a.__data__=i[l],r[l]=a):n[l]=new EnterNode(t,i[l]);for(;l<s;++l)(a=e[l])&&(o[l]=a)}function bindKey(t,e,n,r,o,i,a){var l,s,c,u=new Map,f=e.length,h=i.length,p=new Array(f);for(l=0;l<f;++l)(s=e[l])&&(p[l]=c=a.call(s,s.__data__,l,e)+"",u.has(c)?o[l]=s:u.set(c,s));for(l=0;l<h;++l)c=a.call(t,i[l],l,i)+"",(s=u.get(c))?(r[l]=s,s.__data__=i[l],u.delete(c)):n[l]=new EnterNode(t,i[l]);for(l=0;l<f;++l)(s=e[l])&&u.get(p[l])===s&&(o[l]=s)}function datum(t){return t.__data__}function selection_data(t,e){if(!arguments.length)return Array.from(this,datum);var n=e?bindKey:bindIndex,r=this._parents,o=this._groups;"function"!=typeof t&&(t=constant$2(t));for(var i=o.length,a=new Array(i),l=new Array(i),s=new Array(i),c=0;c<i;++c){var u=r[c],f=o[c],h=f.length,p=arraylike(t.call(u,u&&u.__data__,c,r)),d=p.length,m=l[c]=new Array(d),g=a[c]=new Array(d);n(u,f,m,g,s[c]=new Array(h),p,e);for(var y,v,_=0,w=0;_<d;++_)if(y=m[_]){for(_>=w&&(w=_+1);!(v=g[w])&&++w<d;);y._next=v||null}}return(a=new Selection$1(a,r))._enter=l,a._exit=s,a}function arraylike(t){return"object"==typeof t&&"length"in t?t:Array.from(t)}function selection_exit(){return new Selection$1(this._exit||this._groups.map(sparse),this._parents)}function selection_join(t,e,n){var r=this.enter(),o=this,i=this.exit();return"function"==typeof t?(r=t(r))&&(r=r.selection()):r=r.append(t+""),null!=e&&(o=e(o))&&(o=o.selection()),null==n?i.remove():n(i),r&&o?r.merge(o).order():o}function selection_merge(t){for(var e=t.selection?t.selection():t,n=this._groups,r=e._groups,o=n.length,i=r.length,a=Math.min(o,i),l=new Array(o),s=0;s<a;++s)for(var c,u=n[s],f=r[s],h=u.length,p=l[s]=new Array(h),d=0;d<h;++d)(c=u[d]||f[d])&&(p[d]=c);for(;s<o;++s)l[s]=n[s];return new Selection$1(l,this._parents)}function selection_order(){for(var t=this._groups,e=-1,n=t.length;++e<n;)for(var r,o=t[e],i=o.length-1,a=o[i];--i>=0;)(r=o[i])&&(a&&4^r.compareDocumentPosition(a)&&a.parentNode.insertBefore(r,a),a=r);return this}function selection_sort(t){function e(e,n){return e&&n?t(e.__data__,n.__data__):!e-!n}t||(t=ascending);for(var n=this._groups,r=n.length,o=new Array(r),i=0;i<r;++i){for(var a,l=n[i],s=l.length,c=o[i]=new Array(s),u=0;u<s;++u)(a=l[u])&&(c[u]=a);c.sort(e)}return new Selection$1(o,this._parents).order()}function ascending(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function selection_call(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this}function selection_nodes(){return Array.from(this)}function selection_node(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var r=t[e],o=0,i=r.length;o<i;++o){var a=r[o];if(a)return a}return null}function selection_size(){let t=0;for(const e of this)++t;return t}function selection_empty(){return!this.node()}function selection_each(t){for(var e=this._groups,n=0,r=e.length;n<r;++n)for(var o,i=e[n],a=0,l=i.length;a<l;++a)(o=i[a])&&t.call(o,o.__data__,a,i);return this}function attrRemove$1(t){return function(){this.removeAttribute(t)}}function attrRemoveNS$1(t){return function(){this.removeAttributeNS(t.space,t.local)}}function attrConstant$1(t,e){return function(){this.setAttribute(t,e)}}function attrConstantNS$1(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}function attrFunction$1(t,e){return function(){var n=e.apply(this,arguments);null==n?this.removeAttribute(t):this.setAttribute(t,n)}}function attrFunctionNS$1(t,e){return function(){var n=e.apply(this,arguments);null==n?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,n)}}function selection_attr(t,e){var n=namespace(t);if(arguments.length<2){var r=this.node();return n.local?r.getAttributeNS(n.space,n.local):r.getAttribute(n)}return this.each((null==e?n.local?attrRemoveNS$1:attrRemove$1:"function"==typeof e?n.local?attrFunctionNS$1:attrFunction$1:n.local?attrConstantNS$1:attrConstant$1)(n,e))}function defaultView(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function styleRemove$1(t){return function(){this.style.removeProperty(t)}}function styleConstant$1(t,e,n){return function(){this.style.setProperty(t,e,n)}}function styleFunction$1(t,e,n){return function(){var r=e.apply(this,arguments);null==r?this.style.removeProperty(t):this.style.setProperty(t,r,n)}}function selection_style(t,e,n){return arguments.length>1?this.each((null==e?styleRemove$1:"function"==typeof e?styleFunction$1:styleConstant$1)(t,e,null==n?"":n)):styleValue(this.node(),t)}function styleValue(t,e){return t.style.getPropertyValue(e)||defaultView(t).getComputedStyle(t,null).getPropertyValue(e)}function propertyRemove(t){return function(){delete this[t]}}function propertyConstant(t,e){return function(){this[t]=e}}function propertyFunction(t,e){return function(){var n=e.apply(this,arguments);null==n?delete this[t]:this[t]=n}}function selection_property(t,e){return arguments.length>1?this.each((null==e?propertyRemove:"function"==typeof e?propertyFunction:propertyConstant)(t,e)):this.node()[t]}function classArray(t){return t.trim().split(/^|\s+/)}function classList(t){return t.classList||new ClassList(t)}function ClassList(t){this._node=t,this._names=classArray(t.getAttribute("class")||"")}function classedAdd(t,e){for(var n=classList(t),r=-1,o=e.length;++r<o;)n.add(e[r])}function classedRemove(t,e){for(var n=classList(t),r=-1,o=e.length;++r<o;)n.remove(e[r])}function classedTrue(t){return function(){classedAdd(this,t)}}function classedFalse(t){return function(){classedRemove(this,t)}}function classedFunction(t,e){return function(){(e.apply(this,arguments)?classedAdd:classedRemove)(this,t)}}function selection_classed(t,e){var n=classArray(t+"");if(arguments.length<2){for(var r=classList(this.node()),o=-1,i=n.length;++o<i;)if(!r.contains(n[o]))return!1;return!0}return this.each(("function"==typeof e?classedFunction:e?classedTrue:classedFalse)(n,e))}function textRemove(){this.textContent=""}function textConstant$1(t){return function(){this.textContent=t}}function textFunction$1(t){return function(){var e=t.apply(this,arguments);this.textContent=null==e?"":e}}function selection_text(t){return arguments.length?this.each(null==t?textRemove:("function"==typeof t?textFunction$1:textConstant$1)(t)):this.node().textContent}function htmlRemove(){this.innerHTML=""}function htmlConstant(t){return function(){this.innerHTML=t}}function htmlFunction(t){return function(){var e=t.apply(this,arguments);this.innerHTML=null==e?"":e}}function selection_html(t){return arguments.length?this.each(null==t?htmlRemove:("function"==typeof t?htmlFunction:htmlConstant)(t)):this.node().innerHTML}function raise(){this.nextSibling&&this.parentNode.appendChild(this)}function selection_raise(){return this.each(raise)}function lower(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function selection_lower(){return this.each(lower)}function selection_append(t){var e="function"==typeof t?t:creator(t);return this.select((function(){return this.appendChild(e.apply(this,arguments))}))}function constantNull(){return null}function selection_insert(t,e){var n="function"==typeof t?t:creator(t),r=null==e?constantNull:"function"==typeof e?e:selector(e);return this.select((function(){return this.insertBefore(n.apply(this,arguments),r.apply(this,arguments)||null)}))}function remove(){var t=this.parentNode;t&&t.removeChild(this)}function selection_remove(){return this.each(remove)}function selection_cloneShallow(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function selection_cloneDeep(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function selection_clone(t){return this.select(t?selection_cloneDeep:selection_cloneShallow)}function selection_datum(t){return arguments.length?this.property("__data__",t):this.node().__data__}function contextListener(t){return function(e){t.call(this,e,this.__data__)}}function parseTypenames(t){return t.trim().split(/^|\s+/).map((function(t){var e="",n=t.indexOf(".");return n>=0&&(e=t.slice(n+1),t=t.slice(0,n)),{type:t,name:e}}))}function onRemove(t){return function(){var e=this.__on;if(e){for(var n,r=0,o=-1,i=e.length;r<i;++r)n=e[r],t.type&&n.type!==t.type||n.name!==t.name?e[++o]=n:this.removeEventListener(n.type,n.listener,n.options);++o?e.length=o:delete this.__on}}}function onAdd(t,e,n){return function(){var r,o=this.__on,i=contextListener(e);if(o)for(var a=0,l=o.length;a<l;++a)if((r=o[a]).type===t.type&&r.name===t.name)return this.removeEventListener(r.type,r.listener,r.options),this.addEventListener(r.type,r.listener=i,r.options=n),void(r.value=e);this.addEventListener(t.type,i,n),r={type:t.type,name:t.name,value:e,listener:i,options:n},o?o.push(r):this.__on=[r]}}function selection_on(t,e,n){var r,o,i=parseTypenames(t+""),a=i.length;if(!(arguments.length<2)){for(l=e?onAdd:onRemove,r=0;r<a;++r)this.each(l(i[r],e,n));return this}var l=this.node().__on;if(l)for(var s,c=0,u=l.length;c<u;++c)for(r=0,s=l[c];r<a;++r)if((o=i[r]).type===s.type&&o.name===s.name)return s.value}function dispatchEvent(t,e,n){var r=defaultView(t),o=r.CustomEvent;"function"==typeof o?o=new o(e,n):(o=r.document.createEvent("Event"),n?(o.initEvent(e,n.bubbles,n.cancelable),o.detail=n.detail):o.initEvent(e,!1,!1)),t.dispatchEvent(o)}function dispatchConstant(t,e){return function(){return dispatchEvent(this,t,e)}}function dispatchFunction(t,e){return function(){return dispatchEvent(this,t,e.apply(this,arguments))}}function selection_dispatch(t,e){return this.each(("function"==typeof e?dispatchFunction:dispatchConstant)(t,e))}function*selection_iterator(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var r,o=t[e],i=0,a=o.length;i<a;++i)(r=o[i])&&(yield r)}EnterNode.prototype={constructor:EnterNode,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}},ClassList.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var e=this._names.indexOf(t);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var root=[null];function Selection$1(t,e){this._groups=t,this._parents=e}function selection(){return new Selection$1([[document.documentElement]],root)}function selection_selection(){return this}function select(t){return"string"==typeof t?new Selection$1([[document.querySelector(t)]],[document.documentElement]):new Selection$1([[t]],root)}function create$1(t){return select(creator(t).call(document.documentElement))}function sourceEvent(t){let e;for(;e=t.sourceEvent;)t=e;return t}function pointer(t,e){if(t=sourceEvent(t),void 0===e&&(e=t.currentTarget),e){var n=e.ownerSVGElement||e;if(n.createSVGPoint){var r=n.createSVGPoint();return r.x=t.clientX,r.y=t.clientY,[(r=r.matrixTransform(e.getScreenCTM().inverse())).x,r.y]}if(e.getBoundingClientRect){var o=e.getBoundingClientRect();return[t.clientX-o.left-e.clientLeft,t.clientY-o.top-e.clientTop]}}return[t.pageX,t.pageY]}Selection$1.prototype=selection.prototype={constructor:Selection$1,select:selection_select,selectAll:selection_selectAll,selectChild:selection_selectChild,selectChildren:selection_selectChildren,filter:selection_filter,data:selection_data,enter:selection_enter,exit:selection_exit,join:selection_join,merge:selection_merge,selection:selection_selection,order:selection_order,sort:selection_sort,call:selection_call,nodes:selection_nodes,node:selection_node,size:selection_size,empty:selection_empty,each:selection_each,attr:selection_attr,style:selection_style,property:selection_property,classed:selection_classed,text:selection_text,html:selection_html,raise:selection_raise,lower:selection_lower,append:selection_append,insert:selection_insert,remove:selection_remove,clone:selection_clone,datum:selection_datum,on:selection_on,dispatch:selection_dispatch,[Symbol.iterator]:selection_iterator};const nonpassivecapture={capture:!0,passive:!1};function noevent$1(t){t.preventDefault(),t.stopImmediatePropagation()}function dragDisable(t){var e=t.document.documentElement,n=select(t).on("dragstart.drag",noevent$1,nonpassivecapture);"onselectstart"in e?n.on("selectstart.drag",noevent$1,nonpassivecapture):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function yesdrag(t,e){var n=t.document.documentElement,r=select(t).on("dragstart.drag",null);e&&(r.on("click.drag",noevent$1,nonpassivecapture),setTimeout((function(){r.on("click.drag",null)}),0)),"onselectstart"in n?r.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}function define(t,e,n){t.prototype=e.prototype=n,n.constructor=t}function extend(t,e){var n=Object.create(t.prototype);for(var r in e)n[r]=e[r];return n}function Color(){}var darker=.7,brighter=1/darker,reI="\\s*([+-]?\\d+)\\s*",reN="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",reP="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",reHex=/^#([0-9a-f]{3,8})$/,reRgbInteger=new RegExp(`^rgb\\(${reI},${reI},${reI}\\)$`),reRgbPercent=new RegExp(`^rgb\\(${reP},${reP},${reP}\\)$`),reRgbaInteger=new RegExp(`^rgba\\(${reI},${reI},${reI},${reN}\\)$`),reRgbaPercent=new RegExp(`^rgba\\(${reP},${reP},${reP},${reN}\\)$`),reHslPercent=new RegExp(`^hsl\\(${reN},${reP},${reP}\\)$`),reHslaPercent=new RegExp(`^hsla\\(${reN},${reP},${reP},${reN}\\)$`),named={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function color_formatHex(){return this.rgb().formatHex()}function color_formatHex8(){return this.rgb().formatHex8()}function color_formatHsl(){return hslConvert(this).formatHsl()}function color_formatRgb(){return this.rgb().formatRgb()}function color(t){var e,n;return t=(t+"").trim().toLowerCase(),(e=reHex.exec(t))?(n=e[1].length,e=parseInt(e[1],16),6===n?rgbn(e):3===n?new Rgb(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1):8===n?rgba(e>>24&255,e>>16&255,e>>8&255,(255&e)/255):4===n?rgba(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255):null):(e=reRgbInteger.exec(t))?new Rgb(e[1],e[2],e[3],1):(e=reRgbPercent.exec(t))?new Rgb(255*e[1]/100,255*e[2]/100,255*e[3]/100,1):(e=reRgbaInteger.exec(t))?rgba(e[1],e[2],e[3],e[4]):(e=reRgbaPercent.exec(t))?rgba(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4]):(e=reHslPercent.exec(t))?hsla(e[1],e[2]/100,e[3]/100,1):(e=reHslaPercent.exec(t))?hsla(e[1],e[2]/100,e[3]/100,e[4]):named.hasOwnProperty(t)?rgbn(named[t]):"transparent"===t?new Rgb(NaN,NaN,NaN,0):null}function rgbn(t){return new Rgb(t>>16&255,t>>8&255,255&t,1)}function rgba(t,e,n,r){return r<=0&&(t=e=n=NaN),new Rgb(t,e,n,r)}function rgbConvert(t){return t instanceof Color||(t=color(t)),t?new Rgb((t=t.rgb()).r,t.g,t.b,t.opacity):new Rgb}function rgb(t,e,n,r){return 1===arguments.length?rgbConvert(t):new Rgb(t,e,n,null==r?1:r)}function Rgb(t,e,n,r){this.r=+t,this.g=+e,this.b=+n,this.opacity=+r}function rgb_formatHex(){return`#${hex(this.r)}${hex(this.g)}${hex(this.b)}`}function rgb_formatHex8(){return`#${hex(this.r)}${hex(this.g)}${hex(this.b)}${hex(255*(isNaN(this.opacity)?1:this.opacity))}`}function rgb_formatRgb(){const t=clampa(this.opacity);return`${1===t?"rgb(":"rgba("}${clampi(this.r)}, ${clampi(this.g)}, ${clampi(this.b)}${1===t?")":`, ${t})`}`}function clampa(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function clampi(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function hex(t){return((t=clampi(t))<16?"0":"")+t.toString(16)}function hsla(t,e,n,r){return r<=0?t=e=n=NaN:n<=0||n>=1?t=e=NaN:e<=0&&(t=NaN),new Hsl(t,e,n,r)}function hslConvert(t){if(t instanceof Hsl)return new Hsl(t.h,t.s,t.l,t.opacity);if(t instanceof Color||(t=color(t)),!t)return new Hsl;if(t instanceof Hsl)return t;var e=(t=t.rgb()).r/255,n=t.g/255,r=t.b/255,o=Math.min(e,n,r),i=Math.max(e,n,r),a=NaN,l=i-o,s=(i+o)/2;return l?(a=e===i?(n-r)/l+6*(n<r):n===i?(r-e)/l+2:(e-n)/l+4,l/=s<.5?i+o:2-i-o,a*=60):l=s>0&&s<1?0:a,new Hsl(a,l,s,t.opacity)}function hsl(t,e,n,r){return 1===arguments.length?hslConvert(t):new Hsl(t,e,n,null==r?1:r)}function Hsl(t,e,n,r){this.h=+t,this.s=+e,this.l=+n,this.opacity=+r}function clamph(t){return(t=(t||0)%360)<0?t+360:t}function clampt(t){return Math.max(0,Math.min(1,t||0))}function hsl2rgb(t,e,n){return 255*(t<60?e+(n-e)*t/60:t<180?n:t<240?e+(n-e)*(240-t)/60:e)}function basis(t,e,n,r,o){var i=t*t,a=i*t;return((1-3*t+3*i-a)*e+(4-6*i+3*a)*n+(1+3*t+3*i-3*a)*r+a*o)/6}function basis$1(t){var e=t.length-1;return function(n){var r=n<=0?n=0:n>=1?(n=1,e-1):Math.floor(n*e),o=t[r],i=t[r+1],a=r>0?t[r-1]:2*o-i,l=r<e-1?t[r+2]:2*i-o;return basis((n-r/e)*e,a,o,i,l)}}define(Color,color,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:color_formatHex,formatHex:color_formatHex,formatHex8:color_formatHex8,formatHsl:color_formatHsl,formatRgb:color_formatRgb,toString:color_formatRgb}),define(Rgb,rgb,extend(Color,{brighter(t){return t=null==t?brighter:Math.pow(brighter,t),new Rgb(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=null==t?darker:Math.pow(darker,t),new Rgb(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new Rgb(clampi(this.r),clampi(this.g),clampi(this.b),clampa(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:rgb_formatHex,formatHex:rgb_formatHex,formatHex8:rgb_formatHex8,formatRgb:rgb_formatRgb,toString:rgb_formatRgb})),define(Hsl,hsl,extend(Color,{brighter(t){return t=null==t?brighter:Math.pow(brighter,t),new Hsl(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=null==t?darker:Math.pow(darker,t),new Hsl(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+360*(this.h<0),e=isNaN(t)||isNaN(this.s)?0:this.s,n=this.l,r=n+(n<.5?n:1-n)*e,o=2*n-r;return new Rgb(hsl2rgb(t>=240?t-240:t+120,o,r),hsl2rgb(t,o,r),hsl2rgb(t<120?t+240:t-120,o,r),this.opacity)},clamp(){return new Hsl(clamph(this.h),clampt(this.s),clampt(this.l),clampa(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=clampa(this.opacity);return`${1===t?"hsl(":"hsla("}${clamph(this.h)}, ${100*clampt(this.s)}%, ${100*clampt(this.l)}%${1===t?")":`, ${t})`}`}}));var constant$1=t=>()=>t;function linear$1(t,e){return function(n){return t+n*e}}function exponential(t,e,n){return t=Math.pow(t,n),e=Math.pow(e,n)-t,n=1/n,function(r){return Math.pow(t+r*e,n)}}function gamma(t){return 1==(t=+t)?nogamma:function(e,n){return n-e?exponential(e,n,t):constant$1(isNaN(e)?n:e)}}function nogamma(t,e){var n=e-t;return n?linear$1(t,n):constant$1(isNaN(t)?e:t)}var interpolateRgb=function t(e){var n=gamma(e);function r(t,e){var r=n((t=rgb(t)).r,(e=rgb(e)).r),o=n(t.g,e.g),i=n(t.b,e.b),a=nogamma(t.opacity,e.opacity);return function(e){return t.r=r(e),t.g=o(e),t.b=i(e),t.opacity=a(e),t+""}}return r.gamma=t,r}(1);function rgbSpline(t){return function(e){var n,r,o=e.length,i=new Array(o),a=new Array(o),l=new Array(o);for(n=0;n<o;++n)r=rgb(e[n]),i[n]=r.r||0,a[n]=r.g||0,l[n]=r.b||0;return i=t(i),a=t(a),l=t(l),r.opacity=1,function(t){return r.r=i(t),r.g=a(t),r.b=l(t),r+""}}}var rgbBasis=rgbSpline(basis$1);function numberArray(t,e){e||(e=[]);var n,r=t?Math.min(e.length,t.length):0,o=e.slice();return function(i){for(n=0;n<r;++n)o[n]=t[n]*(1-i)+e[n]*i;return o}}function isNumberArray(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function genericArray(t,e){var n,r=e?e.length:0,o=t?Math.min(r,t.length):0,i=new Array(o),a=new Array(r);for(n=0;n<o;++n)i[n]=interpolate$1(t[n],e[n]);for(;n<r;++n)a[n]=e[n];return function(t){for(n=0;n<o;++n)a[n]=i[n](t);return a}}function date(t,e){var n=new Date;return t=+t,e=+e,function(r){return n.setTime(t*(1-r)+e*r),n}}function interpolateNumber(t,e){return t=+t,e=+e,function(n){return t*(1-n)+e*n}}function object(t,e){var n,r={},o={};for(n in null!==t&&"object"==typeof t||(t={}),null!==e&&"object"==typeof e||(e={}),e)n in t?r[n]=interpolate$1(t[n],e[n]):o[n]=e[n];return function(t){for(n in r)o[n]=r[n](t);return o}}var reA=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,reB=new RegExp(reA.source,"g");function zero(t){return function(){return t}}function one(t){return function(e){return t(e)+""}}function interpolateString(t,e){var n,r,o,i=reA.lastIndex=reB.lastIndex=0,a=-1,l=[],s=[];for(t+="",e+="";(n=reA.exec(t))&&(r=reB.exec(e));)(o=r.index)>i&&(o=e.slice(i,o),l[a]?l[a]+=o:l[++a]=o),(n=n[0])===(r=r[0])?l[a]?l[a]+=r:l[++a]=r:(l[++a]=null,s.push({i:a,x:interpolateNumber(n,r)})),i=reB.lastIndex;return i<e.length&&(o=e.slice(i),l[a]?l[a]+=o:l[++a]=o),l.length<2?s[0]?one(s[0].x):zero(e):(e=s.length,function(t){for(var n,r=0;r<e;++r)l[(n=s[r]).i]=n.x(t);return l.join("")})}function interpolate$1(t,e){var n,r=typeof e;return null==e||"boolean"===r?constant$1(e):("number"===r?interpolateNumber:"string"===r?(n=color(e))?(e=n,interpolateRgb):interpolateString:e instanceof color?interpolateRgb:e instanceof Date?date:isNumberArray(e)?numberArray:Array.isArray(e)?genericArray:"function"!=typeof e.valueOf&&"function"!=typeof e.toString||isNaN(e)?object:interpolateNumber)(t,e)}function interpolateRound(t,e){return t=+t,e=+e,function(n){return Math.round(t*(1-n)+e*n)}}var degrees=180/Math.PI,identity$3={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1},svgNode;function decompose(t,e,n,r,o,i){var a,l,s;return(a=Math.sqrt(t*t+e*e))&&(t/=a,e/=a),(s=t*n+e*r)&&(n-=t*s,r-=e*s),(l=Math.sqrt(n*n+r*r))&&(n/=l,r/=l,s/=l),t*r<e*n&&(t=-t,e=-e,s=-s,a=-a),{translateX:o,translateY:i,rotate:Math.atan2(e,t)*degrees,skewX:Math.atan(s)*degrees,scaleX:a,scaleY:l}}function parseCss(t){const e=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(t+"");return e.isIdentity?identity$3:decompose(e.a,e.b,e.c,e.d,e.e,e.f)}function parseSvg(t){return null==t?identity$3:(svgNode||(svgNode=document.createElementNS("http://www.w3.org/2000/svg","g")),svgNode.setAttribute("transform",t),(t=svgNode.transform.baseVal.consolidate())?decompose((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):identity$3)}function interpolateTransform(t,e,n,r){function o(t){return t.length?t.pop()+" ":""}return function(i,a){var l=[],s=[];return i=t(i),a=t(a),function(t,r,o,i,a,l){if(t!==o||r!==i){var s=a.push("translate(",null,e,null,n);l.push({i:s-4,x:interpolateNumber(t,o)},{i:s-2,x:interpolateNumber(r,i)})}else(o||i)&&a.push("translate("+o+e+i+n)}(i.translateX,i.translateY,a.translateX,a.translateY,l,s),function(t,e,n,i){t!==e?(t-e>180?e+=360:e-t>180&&(t+=360),i.push({i:n.push(o(n)+"rotate(",null,r)-2,x:interpolateNumber(t,e)})):e&&n.push(o(n)+"rotate("+e+r)}(i.rotate,a.rotate,l,s),function(t,e,n,i){t!==e?i.push({i:n.push(o(n)+"skewX(",null,r)-2,x:interpolateNumber(t,e)}):e&&n.push(o(n)+"skewX("+e+r)}(i.skewX,a.skewX,l,s),function(t,e,n,r,i,a){if(t!==n||e!==r){var l=i.push(o(i)+"scale(",null,",",null,")");a.push({i:l-4,x:interpolateNumber(t,n)},{i:l-2,x:interpolateNumber(e,r)})}else 1===n&&1===r||i.push(o(i)+"scale("+n+","+r+")")}(i.scaleX,i.scaleY,a.scaleX,a.scaleY,l,s),i=a=null,function(t){for(var e,n=-1,r=s.length;++n<r;)l[(e=s[n]).i]=e.x(t);return l.join("")}}}var interpolateTransformCss=interpolateTransform(parseCss,"px, ","px)","deg)"),interpolateTransformSvg=interpolateTransform(parseSvg,", ",")",")"),epsilon2=1e-12;function cosh(t){return((t=Math.exp(t))+1/t)/2}function sinh(t){return((t=Math.exp(t))-1/t)/2}function tanh(t){return((t=Math.exp(2*t))-1)/(t+1)}var interpolateZoom=function t(e,n,r){function o(t,o){var i,a,l=t[0],s=t[1],c=t[2],u=o[0],f=o[1],h=o[2],p=u-l,d=f-s,m=p*p+d*d;if(m<epsilon2)a=Math.log(h/c)/e,i=function(t){return[l+t*p,s+t*d,c*Math.exp(e*t*a)]};else{var g=Math.sqrt(m),y=(h*h-c*c+r*m)/(2*c*n*g),v=(h*h-c*c-r*m)/(2*h*n*g),_=Math.log(Math.sqrt(y*y+1)-y),w=Math.log(Math.sqrt(v*v+1)-v);a=(w-_)/e,i=function(t){var r=t*a,o=cosh(_),i=c/(n*g)*(o*tanh(e*r+_)-sinh(_));return[l+i*p,s+i*d,c*o/cosh(e*r+_)]}}return i.duration=1e3*a*e/Math.SQRT2,i}return o.rho=function(e){var n=Math.max(.001,+e),r=n*n;return t(n,r,r*r)},o}(Math.SQRT2,2,4),frame=0,timeout$1=0,interval=0,pokeDelay=1e3,taskHead,taskTail,clockLast=0,clockNow=0,clockSkew=0,clock="object"==typeof performance&&performance.now?performance:Date,setFrame="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function now(){return clockNow||(setFrame(clearNow),clockNow=clock.now()+clockSkew)}function clearNow(){clockNow=0}function Timer(){this._call=this._time=this._next=null}function timer(t,e,n){var r=new Timer;return r.restart(t,e,n),r}function timerFlush(){now(),++frame;for(var t,e=taskHead;e;)(t=clockNow-e._time)>=0&&e._call.call(void 0,t),e=e._next;--frame}function wake(){clockNow=(clockLast=clock.now())+clockSkew,frame=timeout$1=0;try{timerFlush()}finally{frame=0,nap(),clockNow=0}}function poke(){var t=clock.now(),e=t-clockLast;e>pokeDelay&&(clockSkew-=e,clockLast=t)}function nap(){for(var t,e,n=taskHead,r=1/0;n;)n._call?(r>n._time&&(r=n._time),t=n,n=n._next):(e=n._next,n._next=null,n=t?t._next=e:taskHead=e);taskTail=t,sleep(r)}function sleep(t){frame||(timeout$1&&(timeout$1=clearTimeout(timeout$1)),t-clockNow>24?(t<1/0&&(timeout$1=setTimeout(wake,t-clock.now()-clockSkew)),interval&&(interval=clearInterval(interval))):(interval||(clockLast=clock.now(),interval=setInterval(poke,pokeDelay)),frame=1,setFrame(wake)))}function timeout(t,e,n){var r=new Timer;return e=null==e?0:+e,r.restart((n=>{r.stop(),t(n+e)}),e,n),r}Timer.prototype=timer.prototype={constructor:Timer,restart:function(t,e,n){if("function"!=typeof t)throw new TypeError("callback is not a function");n=(null==n?now():+n)+(null==e?0:+e),this._next||taskTail===this||(taskTail?taskTail._next=this:taskHead=this,taskTail=this),this._call=t,this._time=n,sleep()},stop:function(){this._call&&(this._call=null,this._time=1/0,sleep())}};var emptyOn=dispatch("start","end","cancel","interrupt"),emptyTween=[],CREATED=0,SCHEDULED=1,STARTING=2,STARTED=3,RUNNING=4,ENDING=5,ENDED=6;function schedule(t,e,n,r,o,i){var a=t.__transition;if(a){if(n in a)return}else t.__transition={};create(t,n,{name:e,index:r,group:o,on:emptyOn,tween:emptyTween,time:i.time,delay:i.delay,duration:i.duration,ease:i.ease,timer:null,state:CREATED})}function init(t,e){var n=get(t,e);if(n.state>CREATED)throw new Error("too late; already scheduled");return n}function set(t,e){var n=get(t,e);if(n.state>STARTED)throw new Error("too late; already running");return n}function get(t,e){var n=t.__transition;if(!n||!(n=n[e]))throw new Error("transition not found");return n}function create(t,e,n){var r,o=t.__transition;function i(s){var c,u,f,h;if(n.state!==SCHEDULED)return l();for(c in o)if((h=o[c]).name===n.name){if(h.state===STARTED)return timeout(i);h.state===RUNNING?(h.state=ENDED,h.timer.stop(),h.on.call("interrupt",t,t.__data__,h.index,h.group),delete o[c]):+c<e&&(h.state=ENDED,h.timer.stop(),h.on.call("cancel",t,t.__data__,h.index,h.group),delete o[c])}if(timeout((function(){n.state===STARTED&&(n.state=RUNNING,n.timer.restart(a,n.delay,n.time),a(s))})),n.state=STARTING,n.on.call("start",t,t.__data__,n.index,n.group),n.state===STARTING){for(n.state=STARTED,r=new Array(f=n.tween.length),c=0,u=-1;c<f;++c)(h=n.tween[c].value.call(t,t.__data__,n.index,n.group))&&(r[++u]=h);r.length=u+1}}function a(e){for(var o=e<n.duration?n.ease.call(null,e/n.duration):(n.timer.restart(l),n.state=ENDING,1),i=-1,a=r.length;++i<a;)r[i].call(t,o);n.state===ENDING&&(n.on.call("end",t,t.__data__,n.index,n.group),l())}function l(){for(var r in n.state=ENDED,n.timer.stop(),delete o[e],o)return;delete t.__transition}o[e]=n,n.timer=timer((function(t){n.state=SCHEDULED,n.timer.restart(i,n.delay,n.time),n.delay<=t&&i(t-n.delay)}),0,n.time)}function interrupt(t,e){var n,r,o,i=t.__transition,a=!0;if(i){for(o in e=null==e?null:e+"",i)(n=i[o]).name===e?(r=n.state>STARTING&&n.state<ENDING,n.state=ENDED,n.timer.stop(),n.on.call(r?"interrupt":"cancel",t,t.__data__,n.index,n.group),delete i[o]):a=!1;a&&delete t.__transition}}function selection_interrupt(t){return this.each((function(){interrupt(this,t)}))}function tweenRemove(t,e){var n,r;return function(){var o=set(this,t),i=o.tween;if(i!==n)for(var a=0,l=(r=n=i).length;a<l;++a)if(r[a].name===e){(r=r.slice()).splice(a,1);break}o.tween=r}}function tweenFunction(t,e,n){var r,o;if("function"!=typeof n)throw new Error;return function(){var i=set(this,t),a=i.tween;if(a!==r){o=(r=a).slice();for(var l={name:e,value:n},s=0,c=o.length;s<c;++s)if(o[s].name===e){o[s]=l;break}s===c&&o.push(l)}i.tween=o}}function transition_tween(t,e){var n=this._id;if(t+="",arguments.length<2){for(var r,o=get(this.node(),n).tween,i=0,a=o.length;i<a;++i)if((r=o[i]).name===t)return r.value;return null}return this.each((null==e?tweenRemove:tweenFunction)(n,t,e))}function tweenValue(t,e,n){var r=t._id;return t.each((function(){var t=set(this,r);(t.value||(t.value={}))[e]=n.apply(this,arguments)})),function(t){return get(t,r).value[e]}}function interpolate(t,e){var n;return("number"==typeof e?interpolateNumber:e instanceof color?interpolateRgb:(n=color(e))?(e=n,interpolateRgb):interpolateString)(t,e)}function attrRemove(t){return function(){this.removeAttribute(t)}}function attrRemoveNS(t){return function(){this.removeAttributeNS(t.space,t.local)}}function attrConstant(t,e,n){var r,o,i=n+"";return function(){var a=this.getAttribute(t);return a===i?null:a===r?o:o=e(r=a,n)}}function attrConstantNS(t,e,n){var r,o,i=n+"";return function(){var a=this.getAttributeNS(t.space,t.local);return a===i?null:a===r?o:o=e(r=a,n)}}function attrFunction(t,e,n){var r,o,i;return function(){var a,l,s=n(this);if(null!=s)return(a=this.getAttribute(t))===(l=s+"")?null:a===r&&l===o?i:(o=l,i=e(r=a,s));this.removeAttribute(t)}}function attrFunctionNS(t,e,n){var r,o,i;return function(){var a,l,s=n(this);if(null!=s)return(a=this.getAttributeNS(t.space,t.local))===(l=s+"")?null:a===r&&l===o?i:(o=l,i=e(r=a,s));this.removeAttributeNS(t.space,t.local)}}function transition_attr(t,e){var n=namespace(t),r="transform"===n?interpolateTransformSvg:interpolate;return this.attrTween(t,"function"==typeof e?(n.local?attrFunctionNS:attrFunction)(n,r,tweenValue(this,"attr."+t,e)):null==e?(n.local?attrRemoveNS:attrRemove)(n):(n.local?attrConstantNS:attrConstant)(n,r,e))}function attrInterpolate(t,e){return function(n){this.setAttribute(t,e.call(this,n))}}function attrInterpolateNS(t,e){return function(n){this.setAttributeNS(t.space,t.local,e.call(this,n))}}function attrTweenNS(t,e){var n,r;function o(){var o=e.apply(this,arguments);return o!==r&&(n=(r=o)&&attrInterpolateNS(t,o)),n}return o._value=e,o}function attrTween(t,e){var n,r;function o(){var o=e.apply(this,arguments);return o!==r&&(n=(r=o)&&attrInterpolate(t,o)),n}return o._value=e,o}function transition_attrTween(t,e){var n="attr."+t;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==e)return this.tween(n,null);if("function"!=typeof e)throw new Error;var r=namespace(t);return this.tween(n,(r.local?attrTweenNS:attrTween)(r,e))}function delayFunction(t,e){return function(){init(this,t).delay=+e.apply(this,arguments)}}function delayConstant(t,e){return e=+e,function(){init(this,t).delay=e}}function transition_delay(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?delayFunction:delayConstant)(e,t)):get(this.node(),e).delay}function durationFunction(t,e){return function(){set(this,t).duration=+e.apply(this,arguments)}}function durationConstant(t,e){return e=+e,function(){set(this,t).duration=e}}function transition_duration(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?durationFunction:durationConstant)(e,t)):get(this.node(),e).duration}function easeConstant(t,e){if("function"!=typeof e)throw new Error;return function(){set(this,t).ease=e}}function transition_ease(t){var e=this._id;return arguments.length?this.each(easeConstant(e,t)):get(this.node(),e).ease}function easeVarying(t,e){return function(){var n=e.apply(this,arguments);if("function"!=typeof n)throw new Error;set(this,t).ease=n}}function transition_easeVarying(t){if("function"!=typeof t)throw new Error;return this.each(easeVarying(this._id,t))}function transition_filter(t){"function"!=typeof t&&(t=matcher(t));for(var e=this._groups,n=e.length,r=new Array(n),o=0;o<n;++o)for(var i,a=e[o],l=a.length,s=r[o]=[],c=0;c<l;++c)(i=a[c])&&t.call(i,i.__data__,c,a)&&s.push(i);return new Transition(r,this._parents,this._name,this._id)}function transition_merge(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,n=t._groups,r=e.length,o=n.length,i=Math.min(r,o),a=new Array(r),l=0;l<i;++l)for(var s,c=e[l],u=n[l],f=c.length,h=a[l]=new Array(f),p=0;p<f;++p)(s=c[p]||u[p])&&(h[p]=s);for(;l<r;++l)a[l]=e[l];return new Transition(a,this._parents,this._name,this._id)}function start(t){return(t+"").trim().split(/^|\s+/).every((function(t){var e=t.indexOf(".");return e>=0&&(t=t.slice(0,e)),!t||"start"===t}))}function onFunction(t,e,n){var r,o,i=start(e)?init:set;return function(){var a=i(this,t),l=a.on;l!==r&&(o=(r=l).copy()).on(e,n),a.on=o}}function transition_on(t,e){var n=this._id;return arguments.length<2?get(this.node(),n).on.on(t):this.each(onFunction(n,t,e))}function removeFunction(t){return function(){var e=this.parentNode;for(var n in this.__transition)if(+n!==t)return;e&&e.removeChild(this)}}function transition_remove(){return this.on("end.remove",removeFunction(this._id))}function transition_select(t){var e=this._name,n=this._id;"function"!=typeof t&&(t=selector(t));for(var r=this._groups,o=r.length,i=new Array(o),a=0;a<o;++a)for(var l,s,c=r[a],u=c.length,f=i[a]=new Array(u),h=0;h<u;++h)(l=c[h])&&(s=t.call(l,l.__data__,h,c))&&("__data__"in l&&(s.__data__=l.__data__),f[h]=s,schedule(f[h],e,n,h,f,get(l,n)));return new Transition(i,this._parents,e,n)}function transition_selectAll(t){var e=this._name,n=this._id;"function"!=typeof t&&(t=selectorAll(t));for(var r=this._groups,o=r.length,i=[],a=[],l=0;l<o;++l)for(var s,c=r[l],u=c.length,f=0;f<u;++f)if(s=c[f]){for(var h,p=t.call(s,s.__data__,f,c),d=get(s,n),m=0,g=p.length;m<g;++m)(h=p[m])&&schedule(h,e,n,m,p,d);i.push(p),a.push(s)}return new Transition(i,a,e,n)}var Selection=selection.prototype.constructor;function transition_selection(){return new Selection(this._groups,this._parents)}function styleNull(t,e){var n,r,o;return function(){var i=styleValue(this,t),a=(this.style.removeProperty(t),styleValue(this,t));return i===a?null:i===n&&a===r?o:o=e(n=i,r=a)}}function styleRemove(t){return function(){this.style.removeProperty(t)}}function styleConstant(t,e,n){var r,o,i=n+"";return function(){var a=styleValue(this,t);return a===i?null:a===r?o:o=e(r=a,n)}}function styleFunction(t,e,n){var r,o,i;return function(){var a=styleValue(this,t),l=n(this),s=l+"";return null==l&&(this.style.removeProperty(t),s=l=styleValue(this,t)),a===s?null:a===r&&s===o?i:(o=s,i=e(r=a,l))}}function styleMaybeRemove(t,e){var n,r,o,i,a="style."+e,l="end."+a;return function(){var s=set(this,t),c=s.on,u=null==s.value[a]?i||(i=styleRemove(e)):void 0;c===n&&o===u||(r=(n=c).copy()).on(l,o=u),s.on=r}}function transition_style(t,e,n){var r="transform"==(t+="")?interpolateTransformCss:interpolate;return null==e?this.styleTween(t,styleNull(t,r)).on("end.style."+t,styleRemove(t)):"function"==typeof e?this.styleTween(t,styleFunction(t,r,tweenValue(this,"style."+t,e))).each(styleMaybeRemove(this._id,t)):this.styleTween(t,styleConstant(t,r,e),n).on("end.style."+t,null)}function styleInterpolate(t,e,n){return function(r){this.style.setProperty(t,e.call(this,r),n)}}function styleTween(t,e,n){var r,o;function i(){var i=e.apply(this,arguments);return i!==o&&(r=(o=i)&&styleInterpolate(t,i,n)),r}return i._value=e,i}function transition_styleTween(t,e,n){var r="style."+(t+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(null==e)return this.tween(r,null);if("function"!=typeof e)throw new Error;return this.tween(r,styleTween(t,e,null==n?"":n))}function textConstant(t){return function(){this.textContent=t}}function textFunction(t){return function(){var e=t(this);this.textContent=null==e?"":e}}function transition_text(t){return this.tween("text","function"==typeof t?textFunction(tweenValue(this,"text",t)):textConstant(null==t?"":t+""))}function textInterpolate(t){return function(e){this.textContent=t.call(this,e)}}function textTween(t){var e,n;function r(){var r=t.apply(this,arguments);return r!==n&&(e=(n=r)&&textInterpolate(r)),e}return r._value=t,r}function transition_textTween(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(null==t)return this.tween(e,null);if("function"!=typeof t)throw new Error;return this.tween(e,textTween(t))}function transition_transition(){for(var t=this._name,e=this._id,n=newId(),r=this._groups,o=r.length,i=0;i<o;++i)for(var a,l=r[i],s=l.length,c=0;c<s;++c)if(a=l[c]){var u=get(a,e);schedule(a,t,n,c,l,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new Transition(r,this._parents,t,n)}function transition_end(){var t,e,n=this,r=n._id,o=n.size();return new Promise((function(i,a){var l={value:a},s={value:function(){0==--o&&i()}};n.each((function(){var n=set(this,r),o=n.on;o!==t&&((e=(t=o).copy())._.cancel.push(l),e._.interrupt.push(l),e._.end.push(s)),n.on=e})),0===o&&i()}))}var id=0;function Transition(t,e,n,r){this._groups=t,this._parents=e,this._name=n,this._id=r}function newId(){return++id}var selection_prototype=selection.prototype;function cubicInOut(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}Transition.prototype={constructor:Transition,select:transition_select,selectAll:transition_selectAll,selectChild:selection_prototype.selectChild,selectChildren:selection_prototype.selectChildren,filter:transition_filter,merge:transition_merge,selection:transition_selection,transition:transition_transition,call:selection_prototype.call,nodes:selection_prototype.nodes,node:selection_prototype.node,size:selection_prototype.size,empty:selection_prototype.empty,each:selection_prototype.each,on:transition_on,attr:transition_attr,attrTween:transition_attrTween,style:transition_style,styleTween:transition_styleTween,text:transition_text,textTween:transition_textTween,remove:transition_remove,tween:transition_tween,delay:transition_delay,duration:transition_duration,ease:transition_ease,easeVarying:transition_easeVarying,end:transition_end,[Symbol.iterator]:selection_prototype[Symbol.iterator]};var defaultTiming={time:null,delay:0,duration:250,ease:cubicInOut};function inherit(t,e){for(var n;!(n=t.__transition)||!(n=n[e]);)if(!(t=t.parentNode))throw new Error(`transition ${e} not found`);return n}function selection_transition(t){var e,n;t instanceof Transition?(e=t._id,t=t._name):(e=newId(),(n=defaultTiming).time=now(),t=null==t?null:t+"");for(var r=this._groups,o=r.length,i=0;i<o;++i)for(var a,l=r[i],s=l.length,c=0;c<s;++c)(a=l[c])&&schedule(a,t,e,c,l,n||inherit(a,e));return new Transition(r,this._parents,t,e)}function formatDecimal(t){return Math.abs(t=Math.round(t))>=1e21?t.toLocaleString("en").replace(/,/g,""):t.toString(10)}function formatDecimalParts(t,e){if((n=(t=e?t.toExponential(e-1):t.toExponential()).indexOf("e"))<0)return null;var n,r=t.slice(0,n);return[r.length>1?r[0]+r.slice(2):r,+t.slice(n+1)]}function exponent(t){return(t=formatDecimalParts(Math.abs(t)))?t[1]:NaN}function formatGroup(t,e){return function(n,r){for(var o=n.length,i=[],a=0,l=t[0],s=0;o>0&&l>0&&(s+l+1>r&&(l=Math.max(1,r-s)),i.push(n.substring(o-=l,o+l)),!((s+=l+1)>r));)l=t[a=(a+1)%t.length];return i.reverse().join(e)}}function formatNumerals(t){return function(e){return e.replace(/[0-9]/g,(function(e){return t[+e]}))}}selection.prototype.interrupt=selection_interrupt,selection.prototype.transition=selection_transition;var re=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i,prefixExponent;function formatSpecifier(t){if(!(e=re.exec(t)))throw new Error("invalid format: "+t);var e;return new FormatSpecifier({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}function FormatSpecifier(t){this.fill=void 0===t.fill?" ":t.fill+"",this.align=void 0===t.align?">":t.align+"",this.sign=void 0===t.sign?"-":t.sign+"",this.symbol=void 0===t.symbol?"":t.symbol+"",this.zero=!!t.zero,this.width=void 0===t.width?void 0:+t.width,this.comma=!!t.comma,this.precision=void 0===t.precision?void 0:+t.precision,this.trim=!!t.trim,this.type=void 0===t.type?"":t.type+""}function formatTrim(t){t:for(var e,n=t.length,r=1,o=-1;r<n;++r)switch(t[r]){case".":o=e=r;break;case"0":0===o&&(o=r),e=r;break;default:if(!+t[r])break t;o>0&&(o=0)}return o>0?t.slice(0,o)+t.slice(e+1):t}function formatPrefixAuto(t,e){var n=formatDecimalParts(t,e);if(!n)return t+"";var r=n[0],o=n[1],i=o-(prefixExponent=3*Math.max(-8,Math.min(8,Math.floor(o/3))))+1,a=r.length;return i===a?r:i>a?r+new Array(i-a+1).join("0"):i>0?r.slice(0,i)+"."+r.slice(i):"0."+new Array(1-i).join("0")+formatDecimalParts(t,Math.max(0,e+i-1))[0]}function formatRounded(t,e){var n=formatDecimalParts(t,e);if(!n)return t+"";var r=n[0],o=n[1];return o<0?"0."+new Array(-o).join("0")+r:r.length>o+1?r.slice(0,o+1)+"."+r.slice(o+1):r+new Array(o-r.length+2).join("0")}formatSpecifier.prototype=FormatSpecifier.prototype,FormatSpecifier.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(void 0===this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(void 0===this.precision?"":"."+Math.max(0,0|this.precision))+(this.trim?"~":"")+this.type};var formatTypes={"%":(t,e)=>(100*t).toFixed(e),b:t=>Math.round(t).toString(2),c:t=>t+"",d:formatDecimal,e:(t,e)=>t.toExponential(e),f:(t,e)=>t.toFixed(e),g:(t,e)=>t.toPrecision(e),o:t=>Math.round(t).toString(8),p:(t,e)=>formatRounded(100*t,e),r:formatRounded,s:formatPrefixAuto,X:t=>Math.round(t).toString(16).toUpperCase(),x:t=>Math.round(t).toString(16)};function identity$2(t){return t}var map=Array.prototype.map,prefixes=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"],locale,format,formatPrefix;function formatLocale(t){var e=void 0===t.grouping||void 0===t.thousands?identity$2:formatGroup(map.call(t.grouping,Number),t.thousands+""),n=void 0===t.currency?"":t.currency[0]+"",r=void 0===t.currency?"":t.currency[1]+"",o=void 0===t.decimal?".":t.decimal+"",i=void 0===t.numerals?identity$2:formatNumerals(map.call(t.numerals,String)),a=void 0===t.percent?"%":t.percent+"",l=void 0===t.minus?"−":t.minus+"",s=void 0===t.nan?"NaN":t.nan+"";function c(t){var c=(t=formatSpecifier(t)).fill,u=t.align,f=t.sign,h=t.symbol,p=t.zero,d=t.width,m=t.comma,g=t.precision,y=t.trim,v=t.type;"n"===v?(m=!0,v="g"):formatTypes[v]||(void 0===g&&(g=12),y=!0,v="g"),(p||"0"===c&&"="===u)&&(p=!0,c="0",u="=");var _="$"===h?n:"#"===h&&/[boxX]/.test(v)?"0"+v.toLowerCase():"",w="$"===h?r:/[%p]/.test(v)?a:"",x=formatTypes[v],b=/[defgprs%]/.test(v);function S(t){var n,r,a,h=_,S=w;if("c"===v)S=x(t)+S,t="";else{var M=(t=+t)<0||1/t<0;if(t=isNaN(t)?s:x(Math.abs(t),g),y&&(t=formatTrim(t)),M&&0==+t&&"+"!==f&&(M=!1),h=(M?"("===f?f:l:"-"===f||"("===f?"":f)+h,S=("s"===v?prefixes[8+prefixExponent/3]:"")+S+(M&&"("===f?")":""),b)for(n=-1,r=t.length;++n<r;)if(48>(a=t.charCodeAt(n))||a>57){S=(46===a?o+t.slice(n+1):t.slice(n))+S,t=t.slice(0,n);break}}m&&!p&&(t=e(t,1/0));var k=h.length+t.length+S.length,T=k<d?new Array(d-k+1).join(c):"";switch(m&&p&&(t=e(T+t,T.length?d-S.length:1/0),T=""),u){case"<":t=h+t+S+T;break;case"=":t=h+T+t+S;break;case"^":t=T.slice(0,k=T.length>>1)+h+t+S+T.slice(k);break;default:t=T+h+t+S}return i(t)}return g=void 0===g?6:/[gprs]/.test(v)?Math.max(1,Math.min(21,g)):Math.max(0,Math.min(20,g)),S.toString=function(){return t+""},S}return{format:c,formatPrefix:function(t,e){var n=c(((t=formatSpecifier(t)).type="f",t)),r=3*Math.max(-8,Math.min(8,Math.floor(exponent(e)/3))),o=Math.pow(10,-r),i=prefixes[8+r/3];return function(t){return n(o*t)+i}}}}function defaultLocale(t){return locale=formatLocale(t),format=locale.format,formatPrefix=locale.formatPrefix,locale}function precisionFixed(t){return Math.max(0,-exponent(Math.abs(t)))}function precisionPrefix(t,e){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(exponent(e)/3)))-exponent(Math.abs(t)))}function precisionRound(t,e){return t=Math.abs(t),e=Math.abs(e)-t,Math.max(0,exponent(e)-exponent(t))+1}function initRange(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t)}return this}function initInterpolator(t,e){switch(arguments.length){case 0:break;case 1:"function"==typeof t?this.interpolator(t):this.range(t);break;default:this.domain(t),"function"==typeof e?this.interpolator(e):this.range(e)}return this}function constants(t){return function(){return t}}function number(t){return+t}defaultLocale({thousands:",",grouping:[3],currency:["$",""]});var unit=[0,1];function identity$1(t){return t}function normalize(t,e){return(e-=t=+t)?function(n){return(n-t)/e}:constants(isNaN(e)?NaN:.5)}function clamper(t,e){var n;return t>e&&(n=t,t=e,e=n),function(n){return Math.max(t,Math.min(e,n))}}function bimap(t,e,n){var r=t[0],o=t[1],i=e[0],a=e[1];return o<r?(r=normalize(o,r),i=n(a,i)):(r=normalize(r,o),i=n(i,a)),function(t){return i(r(t))}}function polymap(t,e,n){var r=Math.min(t.length,e.length)-1,o=new Array(r),i=new Array(r),a=-1;for(t[r]<t[0]&&(t=t.slice().reverse(),e=e.slice().reverse());++a<r;)o[a]=normalize(t[a],t[a+1]),i[a]=n(e[a],e[a+1]);return function(e){var n=bisect(t,e,1,r)-1;return i[n](o[n](e))}}function copy$1(t,e){return e.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function transformer$1(){var t,e,n,r,o,i,a=unit,l=unit,s=interpolate$1,c=identity$1;function u(){var t=Math.min(a.length,l.length);return c!==identity$1&&(c=clamper(a[0],a[t-1])),r=t>2?polymap:bimap,o=i=null,f}function f(e){return null==e||isNaN(e=+e)?n:(o||(o=r(a.map(t),l,s)))(t(c(e)))}return f.invert=function(n){return c(e((i||(i=r(l,a.map(t),interpolateNumber)))(n)))},f.domain=function(t){return arguments.length?(a=Array.from(t,number),u()):a.slice()},f.range=function(t){return arguments.length?(l=Array.from(t),u()):l.slice()},f.rangeRound=function(t){return l=Array.from(t),s=interpolateRound,u()},f.clamp=function(t){return arguments.length?(c=!!t||identity$1,u()):c!==identity$1},f.interpolate=function(t){return arguments.length?(s=t,u()):s},f.unknown=function(t){return arguments.length?(n=t,f):n},function(n,r){return t=n,e=r,u()}}function continuous(){return transformer$1()(identity$1,identity$1)}function tickFormat(t,e,n,r){var o,i=tickStep(t,e,n);switch((r=formatSpecifier(null==r?",f":r)).type){case"s":var a=Math.max(Math.abs(t),Math.abs(e));return null!=r.precision||isNaN(o=precisionPrefix(i,a))||(r.precision=o),formatPrefix(r,a);case"":case"e":case"g":case"p":case"r":null!=r.precision||isNaN(o=precisionRound(i,Math.max(Math.abs(t),Math.abs(e))))||(r.precision=o-("e"===r.type));break;case"f":case"%":null!=r.precision||isNaN(o=precisionFixed(i))||(r.precision=o-2*("%"===r.type))}return format(r)}function linearish(t){var e=t.domain;return t.ticks=function(t){var n=e();return ticks(n[0],n[n.length-1],null==t?10:t)},t.tickFormat=function(t,n){var r=e();return tickFormat(r[0],r[r.length-1],null==t?10:t,n)},t.nice=function(n){null==n&&(n=10);var r,o,i=e(),a=0,l=i.length-1,s=i[a],c=i[l],u=10;for(c<s&&(o=s,s=c,c=o,o=a,a=l,l=o);u-- >0;){if((o=tickIncrement(s,c,n))===r)return i[a]=s,i[l]=c,e(i);if(o>0)s=Math.floor(s/o)*o,c=Math.ceil(c/o)*o;else{if(!(o<0))break;s=Math.ceil(s*o)/o,c=Math.floor(c*o)/o}r=o}return t},t}function linear(){var t=continuous();return t.copy=function(){return copy$1(t,linear())},initRange.apply(t,arguments),linearish(t)}function transformer(){var t,e,n,r,o,i=0,a=1,l=identity$1,s=!1;function c(e){return null==e||isNaN(e=+e)?o:l(0===n?.5:(e=(r(e)-t)*n,s?Math.max(0,Math.min(1,e)):e))}function u(t){return function(e){var n,r;return arguments.length?([n,r]=e,l=t(n,r),c):[l(0),l(1)]}}return c.domain=function(o){return arguments.length?([i,a]=o,t=r(i=+i),e=r(a=+a),n=t===e?0:1/(e-t),c):[i,a]},c.clamp=function(t){return arguments.length?(s=!!t,c):s},c.interpolator=function(t){return arguments.length?(l=t,c):l},c.range=u(interpolate$1),c.rangeRound=u(interpolateRound),c.unknown=function(t){return arguments.length?(o=t,c):o},function(o){return r=o,t=o(i),e=o(a),n=t===e?0:1/(e-t),c}}function copy(t,e){return e.domain(t.domain()).interpolator(t.interpolator()).clamp(t.clamp()).unknown(t.unknown())}function sequential(){var t=linearish(transformer()(identity$1));return t.copy=function(){return copy(t,sequential())},initInterpolator.apply(t,arguments)}function colors(t){for(var e=t.length/6|0,n=new Array(e),r=0;r<e;)n[r]="#"+t.slice(6*r,6*++r);return n}var ramp=t=>rgbBasis(t[t.length-1]),scheme$1=new Array(3).concat("f7fcb9addd8e31a354","ffffccc2e69978c679238443","ffffccc2e69978c67931a354006837","ffffccd9f0a3addd8e78c67931a354006837","ffffccd9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443006837004529").map(colors),YlGn=ramp(scheme$1),scheme=new Array(3).concat("fee6cefdae6be6550d","feeddefdbe85fd8d3cd94701","feeddefdbe85fd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d94801a636037f2704").map(colors),Oranges=ramp(scheme),constant=t=>()=>t;function ZoomEvent(t,{sourceEvent:e,target:n,transform:r,dispatch:o}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:o}})}function Transform(t,e,n){this.k=t,this.x=e,this.y=n}Transform.prototype={constructor:Transform,scale:function(t){return 1===t?this:new Transform(this.k*t,this.x,this.y)},translate:function(t,e){return 0===t&0===e?this:new Transform(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var identity=new Transform(1,0,0);function transform(t){for(;!t.__zoom;)if(!(t=t.parentNode))return identity;return t.__zoom}function nopropagation(t){t.stopImmediatePropagation()}function noevent(t){t.preventDefault(),t.stopImmediatePropagation()}function defaultFilter(t){return!(t.ctrlKey&&"wheel"!==t.type||t.button)}function defaultExtent(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t).hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]:[[0,0],[t.clientWidth,t.clientHeight]]}function defaultTransform(){return this.__zoom||identity}function defaultWheelDelta(t){return-t.deltaY*(1===t.deltaMode?.05:t.deltaMode?1:.002)*(t.ctrlKey?10:1)}function defaultTouchable(){return navigator.maxTouchPoints||"ontouchstart"in this}function defaultConstrain(t,e,n){var r=t.invertX(e[0][0])-n[0][0],o=t.invertX(e[1][0])-n[1][0],i=t.invertY(e[0][1])-n[0][1],a=t.invertY(e[1][1])-n[1][1];return t.translate(o>r?(r+o)/2:Math.min(0,r)||Math.max(0,o),a>i?(i+a)/2:Math.min(0,i)||Math.max(0,a))}function zoom(){var t,e,n,r=defaultFilter,o=defaultExtent,i=defaultConstrain,a=defaultWheelDelta,l=defaultTouchable,s=[0,1/0],c=[[-1/0,-1/0],[1/0,1/0]],u=250,f=interpolateZoom,h=dispatch("start","zoom","end"),p=500,d=150,m=0,g=10;function y(t){t.property("__zoom",defaultTransform).on("wheel.zoom",M,{passive:!1}).on("mousedown.zoom",k).on("dblclick.zoom",T).filter(l).on("touchstart.zoom",$).on("touchmove.zoom",F).on("touchend.zoom touchcancel.zoom",N).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function v(t,e){return(e=Math.max(s[0],Math.min(s[1],e)))===t.k?t:new Transform(e,t.x,t.y)}function _(t,e,n){var r=e[0]-n[0]*t.k,o=e[1]-n[1]*t.k;return r===t.x&&o===t.y?t:new Transform(t.k,r,o)}function w(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function x(t,e,n,r){t.on("start.zoom",(function(){b(this,arguments).event(r).start()})).on("interrupt.zoom end.zoom",(function(){b(this,arguments).event(r).end()})).tween("zoom",(function(){var t=this,i=arguments,a=b(t,i).event(r),l=o.apply(t,i),s=null==n?w(l):"function"==typeof n?n.apply(t,i):n,c=Math.max(l[1][0]-l[0][0],l[1][1]-l[0][1]),u=t.__zoom,h="function"==typeof e?e.apply(t,i):e,p=f(u.invert(s).concat(c/u.k),h.invert(s).concat(c/h.k));return function(t){if(1===t)t=h;else{var e=p(t),n=c/e[2];t=new Transform(n,s[0]-e[0]*n,s[1]-e[1]*n)}a.zoom(null,t)}}))}function b(t,e,n){return!n&&t.__zooming||new S(t,e)}function S(t,e){this.that=t,this.args=e,this.active=0,this.sourceEvent=null,this.extent=o.apply(t,e),this.taps=0}function M(t,...e){if(r.apply(this,arguments)){var n=b(this,e).event(t),o=this.__zoom,l=Math.max(s[0],Math.min(s[1],o.k*Math.pow(2,a.apply(this,arguments)))),u=pointer(t);if(n.wheel)n.mouse[0][0]===u[0]&&n.mouse[0][1]===u[1]||(n.mouse[1]=o.invert(n.mouse[0]=u)),clearTimeout(n.wheel);else{if(o.k===l)return;n.mouse=[u,o.invert(u)],interrupt(this),n.start()}noevent(t),n.wheel=setTimeout((function(){n.wheel=null,n.end()}),d),n.zoom("mouse",i(_(v(o,l),n.mouse[0],n.mouse[1]),n.extent,c))}}function k(t,...e){if(!n&&r.apply(this,arguments)){var o=t.currentTarget,a=b(this,e,!0).event(t),l=select(t.view).on("mousemove.zoom",(function(t){if(noevent(t),!a.moved){var e=t.clientX-u,n=t.clientY-f;a.moved=e*e+n*n>m}a.event(t).zoom("mouse",i(_(a.that.__zoom,a.mouse[0]=pointer(t,o),a.mouse[1]),a.extent,c))}),!0).on("mouseup.zoom",(function(t){l.on("mousemove.zoom mouseup.zoom",null),yesdrag(t.view,a.moved),noevent(t),a.event(t).end()}),!0),s=pointer(t,o),u=t.clientX,f=t.clientY;dragDisable(t.view),nopropagation(t),a.mouse=[s,this.__zoom.invert(s)],interrupt(this),a.start()}}function T(t,...e){if(r.apply(this,arguments)){var n=this.__zoom,a=pointer(t.changedTouches?t.changedTouches[0]:t,this),l=n.invert(a),s=n.k*(t.shiftKey?.5:2),f=i(_(v(n,s),a,l),o.apply(this,e),c);noevent(t),u>0?select(this).transition().duration(u).call(x,f,a,t):select(this).call(y.transform,f,a,t)}}function $(n,...o){if(r.apply(this,arguments)){var i,a,l,s,c=n.touches,u=c.length,f=b(this,o,n.changedTouches.length===u).event(n);for(nopropagation(n),a=0;a<u;++a)s=[s=pointer(l=c[a],this),this.__zoom.invert(s),l.identifier],f.touch0?f.touch1||f.touch0[2]===s[2]||(f.touch1=s,f.taps=0):(f.touch0=s,i=!0,f.taps=1+!!t);t&&(t=clearTimeout(t)),i&&(f.taps<2&&(e=s[0],t=setTimeout((function(){t=null}),p)),interrupt(this),f.start())}}function F(t,...e){if(this.__zooming){var n,r,o,a,l=b(this,e).event(t),s=t.changedTouches,u=s.length;for(noevent(t),n=0;n<u;++n)o=pointer(r=s[n],this),l.touch0&&l.touch0[2]===r.identifier?l.touch0[0]=o:l.touch1&&l.touch1[2]===r.identifier&&(l.touch1[0]=o);if(r=l.that.__zoom,l.touch1){var f=l.touch0[0],h=l.touch0[1],p=l.touch1[0],d=l.touch1[1],m=(m=p[0]-f[0])*m+(m=p[1]-f[1])*m,g=(g=d[0]-h[0])*g+(g=d[1]-h[1])*g;r=v(r,Math.sqrt(m/g)),o=[(f[0]+p[0])/2,(f[1]+p[1])/2],a=[(h[0]+d[0])/2,(h[1]+d[1])/2]}else{if(!l.touch0)return;o=l.touch0[0],a=l.touch0[1]}l.zoom("touch",i(_(r,o,a),l.extent,c))}}function N(t,...r){if(this.__zooming){var o,i,a=b(this,r).event(t),l=t.changedTouches,s=l.length;for(nopropagation(t),n&&clearTimeout(n),n=setTimeout((function(){n=null}),p),o=0;o<s;++o)i=l[o],a.touch0&&a.touch0[2]===i.identifier?delete a.touch0:a.touch1&&a.touch1[2]===i.identifier&&delete a.touch1;if(a.touch1&&!a.touch0&&(a.touch0=a.touch1,delete a.touch1),a.touch0)a.touch0[1]=this.__zoom.invert(a.touch0[0]);else if(a.end(),2===a.taps&&(i=pointer(i,this),Math.hypot(e[0]-i[0],e[1]-i[1])<g)){var c=select(this).on("dblclick.zoom");c&&c.apply(this,arguments)}}}return y.transform=function(t,e,n,r){var o=t.selection?t.selection():t;o.property("__zoom",defaultTransform),t!==o?x(t,e,n,r):o.interrupt().each((function(){b(this,arguments).event(r).start().zoom(null,"function"==typeof e?e.apply(this,arguments):e).end()}))},y.scaleBy=function(t,e,n,r){y.scaleTo(t,(function(){return this.__zoom.k*("function"==typeof e?e.apply(this,arguments):e)}),n,r)},y.scaleTo=function(t,e,n,r){y.transform(t,(function(){var t=o.apply(this,arguments),r=this.__zoom,a=null==n?w(t):"function"==typeof n?n.apply(this,arguments):n,l=r.invert(a),s="function"==typeof e?e.apply(this,arguments):e;return i(_(v(r,s),a,l),t,c)}),n,r)},y.translateBy=function(t,e,n,r){y.transform(t,(function(){return i(this.__zoom.translate("function"==typeof e?e.apply(this,arguments):e,"function"==typeof n?n.apply(this,arguments):n),o.apply(this,arguments),c)}),null,r)},y.translateTo=function(t,e,n,r,a){y.transform(t,(function(){var t=o.apply(this,arguments),a=this.__zoom,l=null==r?w(t):"function"==typeof r?r.apply(this,arguments):r;return i(identity.translate(l[0],l[1]).scale(a.k).translate("function"==typeof e?-e.apply(this,arguments):-e,"function"==typeof n?-n.apply(this,arguments):-n),t,c)}),r,a)},S.prototype={event:function(t){return t&&(this.sourceEvent=t),this},start:function(){return 1==++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(t,e){return this.mouse&&"mouse"!==t&&(this.mouse[1]=e.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=e.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=e.invert(this.touch1[0])),this.that.__zoom=e,this.emit("zoom"),this},end:function(){return 0==--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(t){var e=select(this.that).datum();h.call(t,this.that,new ZoomEvent(t,{sourceEvent:this.sourceEvent,target:y,type:t,transform:this.that.__zoom,dispatch:h}),e)}},y.wheelDelta=function(t){return arguments.length?(a="function"==typeof t?t:constant(+t),y):a},y.filter=function(t){return arguments.length?(r="function"==typeof t?t:constant(!!t),y):r},y.touchable=function(t){return arguments.length?(l="function"==typeof t?t:constant(!!t),y):l},y.extent=function(t){return arguments.length?(o="function"==typeof t?t:constant([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),y):o},y.scaleExtent=function(t){return arguments.length?(s[0]=+t[0],s[1]=+t[1],y):[s[0],s[1]]},y.translateExtent=function(t){return arguments.length?(c[0][0]=+t[0][0],c[1][0]=+t[1][0],c[0][1]=+t[0][1],c[1][1]=+t[1][1],y):[[c[0][0],c[0][1]],[c[1][0],c[1][1]]]},y.constrain=function(t){return arguments.length?(i=t,y):i},y.duration=function(t){return arguments.length?(u=+t,y):u},y.interpolate=function(t){return arguments.length?(f=t,y):f},y.on=function(){var t=h.on.apply(h,arguments);return t===h?y:t},y.clickDistance=function(t){return arguments.length?(m=(t=+t)*t,y):Math.sqrt(m)},y.tapDistance=function(t){return arguments.length?(g=+t,y):g},y}transform.prototype=Transform.prototype;const _drawLegend=function(t){const e=t.numBins,n=t.context,r=t.minV,o=t.maxV,i=t.values,a=t.x,l=t.y,s=t.width,c=t.height,u=t.colourScale,f=Array(e+2).fill(0),h=(o-r)/f.length;for(const t of i)if(t){const e=Math.trunc((t-r)/h)+1;e<1?f[0]++:e>f.length-2?f[f.length-1]++:f[e]++}const p=Math.max(...f.slice(1,-2)),d=linear().domain([0,p]).range([0,c-30]),m=s/f.length;n.fillStyle="#fff8",n.fillRect(a,l,s,c);for(let t=0;t<f.length;t++)n.fillStyle=u(t/f.length),n.fillRect(a+t*m,l+c-10,m,-10),0==t?n.fillStyle=u(0):t==f.length-1?n.fillStyle=u(1):n.fillStyle=u(.5),n.fillRect(a+t*m,l+c-20,m,-Math.min(d(f[t]),c-20));n.fillStyle="#000",n.font="sans-serif 8pt",n.textBaseline="bottom",n.textAlign="left",n.fillText(r.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:3}),a+m,l+c),n.textAlign="right",n.fillText(o.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:3}),a+s-m,l+c)};function _blur(t){const e=t.grid,n=t.discretiser,r=t.properties,o=t.propertyTypes;if(void 0===r||void 0===o)return void console.log("Need to define properties and propertyTypes for smoothing");const i=t.kernelRadius,a=e.length+i,l=Math.max(...Object.values(e.map((t=>t.length))))+i;for(let t=0;t<r.length;t++)if("value"===o[t]){const o=[];for(let n=0;n<l;n++)for(let i=0;i<a;i++)o.push(e[i]&&e[i][n]&&e[i][n][r[t]]?e[i][n][r[t]]:0);blur2({data:o,width:a,height:l},i);for(let i=0;i<a;i++)for(let s=0;s<l;s++){const l=o[i+s*a];l>0?(e[i]||(e[i]=[]),e[i][s]||(e[i][s]={getBoundary:()=>n.getBoundary(i,s),getXCentre:()=>n.getXYCentre(i,s)[0]+e.xOffset,getYCentre:()=>n.getXYCentre(i,s)[1]+e.yOffset,getCellSize:()=>n.getCellSize(),new:!0}),e[i][s][r[t]]=l):e[i]&&e[i][s]&&e[i][s][r[t]]&&(e[i][s][r[t]]=l)}}return e}const _getGridDiscretiser=function(t){return{getColRow:(e,n)=>[Math.trunc(e/t),Math.trunc(n/t)],getXYCentre:(e,n)=>[e*t+t/2,n*t+t/2],getBoundary:(e,n,r)=>{const o=r?t-2*r:t,i=[e*t+t/2,n*t+t/2];return[[i[0]-o/2,i[1]-o/2],[i[0]+o/2,i[1]-o/2],[i[0]+o/2,i[1]+o/2],[i[0]-o/2,i[1]+o/2]]},getBoundaryScreenCoord:(e,n,r)=>{const o=r?t-2*r:t,i=[e,n];return[[i[0]-o/2,i[1]-o/2],[i[0]+o/2,i[1]-o/2],[i[0]+o/2,i[1]+o/2],[i[0]-o/2,i[1]+o/2]]},getCellSize:()=>t,type:"grid"}},_getHexDiscretiser=function(t){function e(t){const e={NEIGHBORS_DI:[0,1,1,0,-1,-1],NEIGHBORS_DJ:[[-1,-1,0,1,0,-1],[-1,0,1,1,1,0]],NUM_NEIGHBORS:6};e.RADIUS=Math.trunc(1.3*t/2),e.WIDTH=2*e.RADIUS,e.HEIGHT=Math.trunc(e.RADIUS*Math.sqrt(3)),e.SIDE=3*e.RADIUS/2;let n=[e.RADIUS/2,e.SIDE,e.WIDTH,e.SIDE,e.RADIUS/2,0];e.CORNERS_DX=n;let r=[0,0,e.HEIGHT/2,e.HEIGHT,e.HEIGHT,e.HEIGHT/2];return e.CORNERS_DY=r,e}const n=e(t);let r,o;return{getColRow:(t,e)=>{let r=Math.floor(t/n.SIDE),o=t-n.SIDE*r,i=e-r%2*n.HEIGHT/2,a=Math.floor(i/n.HEIGHT),l=i-n.HEIGHT*a;return o>Math.abs(n.RADIUS/2-n.RADIUS*l/n.HEIGHT)?[r,a]:[r-1,a+r%2-(l<n.HEIGHT/2?1:0)]},getXYCentre:(t,e)=>{let r=[t*n.SIDE,n.HEIGHT*(2*e+t%2)/2];return[r[0]+n.RADIUS,r[1]+n.HEIGHT/2]},getXYCentreCellUnits:(t,e)=>{const n=Math.sqrt(3);let r=[1.5*t,n*(2*e+t%2)/2];return[r[0]+1,r[1]+n/2]},getBoundary:(i,a,l)=>{let s=[];l||(l=0),l>0&&l!=r&&(r=l,o=e(t-2*l));const c=l?o:n;let u=[i*n.SIDE,n.HEIGHT*(2*a+i%2)/2];for(let t=0;t<c.NUM_NEIGHBORS;t++)s.push([Math.round(u[0]+2*l/3*2+c.CORNERS_DX[t]),Math.round(u[1]+2*l/3*2+c.CORNERS_DY[t])]);return s},getCellSize:()=>t,type:"hex"}},_generate2DHeatMap=function(t){const e=t.data,n=t.width,r=t.height,o=t.cellSize,i=t.getLocationFn,a=t.coordToScreenFn,l=t.screenToCoordFn,s=t.preAggrFn,c=t.aggrFn,u=t.postAggrFn,f=t.offSetCoordRef,h=t.discretisationMode,p=t.reduceMaup,d=t.panel,m=t.discretiser,g=t.global,y=t.offSetMaupMode;let v=[];"relativeToMouse"==h?(v.xOffset=Math.trunc(a(f)[0]%o),v.yOffset=Math.trunc(a(f)[1]%o)):(v.xOffset=0,v.yOffset=0),v.type=m.type,v.cellSize=o;const _=l([0,r]),w=l([n,0]);s&&s(v.flat(),o,g,d);for(let t of e){const e=[],n=i(t);if(n.type){const t=turf.bbox(n),r=a([t[0],t[1]]),i=a([t[2],t[3]]);for(let t=Math.trunc(r[0]/o);t<i[0]/o;t++)for(let n=Math.trunc(r[1]/o);n<i[1]/o;n++)e.push([t,n]);if(0==e.length){const t=turf.centroid(n);e.push([Math.trunc(t[0]/o),Math.trunc(t[1]/o)])}}else if(n[0]>=_[0]&&n[0]<=w[0]&&n[1]>=_[1]&&n[1]<=w[1]){const t=a(n);if(p){console.log("mauping");const n=m.getColRow(t[0]-v.xOffset,t[1]-v.yOffset),r=t[0]-v.xOffset-n[0]*o,i=t[1]-v.yOffset-n[1]*o;let a=r/o;a<.5?a=-(.5-a):a-=.5;let l=i/o;l<.5?l=-(.5-l):l-=.5,e.push([n[0],n[1],1-(Math.abs(a)+Math.abs(l))/2]),e.push([n[0]+(a<0?-1:1),n[1]+(l<0?-1:1),(Math.abs(a)+Math.abs(l))/2]),e.push([n[0]+(a<0?-1:1),n[1],Math.abs(a)]),e.push([n[0],n[1]+(l<0?-1:1),Math.abs(l)])}else{if(y)for(let n=0;n<o;n+=3)for(let r=0;r<o;r+=3)e.push([...m.getColRow(t[0]+(n-o/2)-v.xOffset,t[1]+(n-o/2)-v.yOffset),r*o+n]);e.push(m.getColRow(t[0]-v.xOffset,t[1]-v.yOffset))}}for(const n of e)if(v[n[0]]||(v[n[0]]=[]),v[n[0]][n[1]]||(v[n[0]][n[1]]={getBoundary:t=>m.getBoundary(n[0],n[1],t),getXCentre:()=>m.getXYCentre(n[0],n[1])[0]+v.xOffset,getYCentre:()=>m.getXYCentre(n[0],n[1])[1]+v.yOffset,getCellSize:()=>o}),c)if(Array.isArray(c))for(const e of c)e&&e(v[n[0]][n[1]],t,n[2]?n[2]:1,g,d);else y?c(v[n[0]][n[1]],{...t,maupMode:n[2]},1,g,d):c(v[n[0]][n[1]],t,n[2]?n[2]:1,g,d)}return u&&u(v.flat(),o,g,d),v},_setupParamFns=t=>{const e=t.name,n=t.decKey,r=t.incKey,o=t.resetKey;t.incDecType;const i=t.decFn?t.decFn:t=>t-1,a=t.incFn?t.incFn:t=>t+1,l=t.numberFormatFn?t.numberFormatFn:t=>+t.toFixed(),s=t.resetFn,c=t.resetType?t.resetType:"preDraw";let u=void 0!==t.autoscale&&t.autoscale;const f=t.onChangeFn,h=(t,n)=>{null!=t[e]&&(t[e]=a(t[e])),f&&f(t),n.redraw()},p=(t,n)=>{null!=t[e]&&(t[e]=i(t[e])),f&&f(t),n.redraw()},d=(t,n)=>{t[e]=void 0,f&&f(t),n.redraw()},m=()=>u;return{...t,initFn:(t,e,i,a)=>{a.addEventListener("keydown",(t=>{(n&&n.startsWith("SHIFT_")===t.shiftKey&&(n.endsWith("LEFT")&&37==t.keyCode||n.endsWith("RIGHT")&&39==t.keyCode)||t.key===n)&&(t.preventDefault(),p(i,a)),(r&&r.startsWith("SHIFT_")===t.shiftKey&&(r.endsWith("LEFT")&&37==t.keyCode||r.endsWith("RIGHT")&&39==t.keyCode)||t.key===r)&&(t.preventDefault(),h(i,a)),o&&t.key==o&&(t.preventDefault(),d(i,a))}))},toggleAutoscale:()=>{u=!u},getAutoscale:m,preAggrFn:"preAggr"==c?(t,n,r,o,i)=>{s&&(m()||void 0===o[e])&&(o[e]=s(t.flat(),n,i))}:void 0,preDrawFn:"preDraw"==c?(t,n,r,o,i)=>{s&&(m()||void 0===o[e])&&(o[e]=s(t.flat(),n,i))}:void 0,doInc:h,doDec:p,doReset:d,numberFormatFn:l}};function _drawCellBackground(t,e,n,r){const o=e.getBoundary(r);t.fillStyle=n,t.beginPath(),t.moveTo(o[0][0],o[0][1]);for(let e=1;e<o.length;e++)t.lineTo(o[e][0],o[e][1]);t.closePath(),t.fill()}const mapTypes={OSMMapnik:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.tile.osm.org/${n}/${t}/${e}.png`},CartoDBVoyager:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/rastertiles/voyager/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},CartoDBVoyagerNoLabel:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},CartoDark:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/dark_all/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},CartoPositronNoLabel:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/dark_nolabels/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},CartoPositron:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/light_all/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},CartoPositronNoLabel:function(t,e,n){return`https://${"abc"[Math.abs(t+e)%3]}.basemaps.cartocdn.com/light_nolabels/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaStamenToner:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/stamen_toner/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaStamenTonerLite:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/stamen_toner_lite/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaStamenWatercolor:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/stamen_watercolor/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaStamenOutdoor:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/outdoors/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaStamenTerrain:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/stamen_terrain/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaAlidade:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/alidade_smooth/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaAlidadeDark:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StadiaOSMBright:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/osm_bright/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StamenTerrain:function(t,e,n){return`https://stamen-tiles-${"abc"[Math.abs(t+e)%3]}.a.ssl.fastly.net/terrain/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StamenToner:function(t,e,n){return`https://stamen-tiles-${"abc"[Math.abs(t+e)%3]}.a.ssl.fastly.net/toner/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StamenTonerHybrid:function(t,e,n){return`https://stamen-tiles-${"abc"[Math.abs(t+e)%3]}.a.ssl.fastly.net/toner-hybrid/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png`},StamenTonerLite:function(t,e,n){return`https://tiles.stadiamaps.com/tiles/stamen_toner_lite/${n}/${t}/${e}${devicePixelRatio>1?"@2x":""}.png?api_key=72123526-80f2-47a1-9d0c-a4a0aeb78b42`},StamenWatercolor:function(t,e,n){return`https://stamen-tiles-${"abc"[Math.abs(t+e)%3]}.a.ssl.fastly.net/watercolor/${n}/${t}/${e}.png`},OSMStandard:function(t,e,n){return`https://tile.openstreetmap.org/${n}/${t}/${e}.png`},WikimediaMaps:function(t,e,n){return`https://maps.wikimedia.org/osm-intl/${n}/${t}/${e}.png`}};function _drawSlippyMap(t){const e=t.mapType?t.mapType:"OSMMapnik",n=t.tileWidth?t.tileWidth:256,r=t.tileStore?t.tileStore:{},o=t.ctx,i=t.transform?t.transform:d3.zoomIdentity,a=t.xMap?t.xMap:d3.scaleLinear(),l=t.yMap?t.yMap:d3.scaleLinear(),s=t.mercXToLon,c=t.mercYToLat;t.lonToMercX,t.latToMercY;const u=t.coordToScreen;t.screenToCoord;const f=t.greyscale;function h(t,e,n){return Math.min(Math.max(t,e),n)}function p(t,e){return h(Math.floor((t+180)/360*Math.pow(2,e)),0,Math.pow(2,e)-1)}function d(t,e){return h(Math.floor((1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)),0,Math.pow(2,e)-1)}function m(t,e){return t/Math.pow(2,e)*360-180}function g(t,e){const n=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))}function y(t,e,n,r,o){return mapTypes[r](t,e,n)}const v=o.canvas.width/n;let _=p(s(a.invert((1152-i.x)/i.k)),19)-p(s(a.invert((0-i.x)/i.k)),19),w=19;for(;_>v;)_/=2,w--;let x=w;const b=p(s(a.invert((0-i.x)/i.k)),x),S=p(s(a.invert((1152-i.x)/i.k)),x),M=d(c(l.invert((0-i.y)/i.k)),x),k=d(c(l.invert((o.canvas.height-i.y)/i.k)),x);o.clearRect(0,0,o.canvas.width,o.canvas.height),f&&(o.filter="grayscale(1)");const T=[],$=[];for(let t=b;t<=S;t++)for(let n=M;n<=k;n++){const i=t,a=n,l=y(i,a,x,e);let s;r&&(s=r[l]),s||(s=new Image,s.src=l,r&&(r[l]=s));let c=T.findIndex((t=>t.tileX===i&&t.tileY===a));if(-1===c){const t=m(i,x),e=g(a,x),n=m(i+1,x),r=g(a+1,x),o=u([t,0])[0],l=u([n,0])[0],s=u([0,e])[1],f=u([0,r])[1];T.push({tileX:i,tileY:a}),$.push({tileScreenX:o,tileScreenX2:l,tileScreenY:s,tileScreenY2:f}),c=T.length-1}const{tileScreenX:f,tileScreenX2:h,tileScreenY:p,tileScreenY2:d}=$[c];o.drawImage(s,f,p,h-f,d-p)}f&&(o.filter="none")}function slippyMap(t){const e=!t.coordType||"mercator"==t.coordType,n=t.width,r=t.height,o=t.tileWidth?t.tileWidth:256;let i,a;t.initFn&&(i=[t.initFn]),t.drawFn&&(a=[t.drawFn]);const l=t.initialBB,s=t.greyscale,c=t.mapType;let u,f;const h=void 0===t.interactiveZoomPan||t.interactiveZoomPan,p=create$1("div");p.style.width=n;const d=select(p).node().append("canvas").node(),m=d.getContext("2d");m.imageSmoothingEnabled=!0,d.width=n,d.height=r;const g=zoom().scaleExtent([0,5e4]),y={};let v;if(e)v=[w(-180),_(90),w(180),_(-90)];else if(!e&&t.initialBB){const e=Math.abs((t.initialBB[0]-t.initialBB[2])/n),o=Math.abs((t.initialBB[1]-t.initialBB[3])/r);v=e<o?[t.initialBB[0],t.initialBB[1],t.initialBB[0]+n*o,t.initialBB[3]]:[t.initialBB[0],t.initialBB[3]-r*e,t.initialBB[2],t.initialBB[3]]}else v=[0,0,n,r];function _(t){return t<-85?t=-85:t>85&&(t=85),Math.log(Math.tan(M(t))+1/Math.cos(M(t)))}function w(t){return t<-180?t=-180:t>180&&(t=180),M(t)}function x(t){return S(Math.atan(Math.sinh(t)))}function b(t){return S(t)}function S(t){return 180*t/Math.PI}function M(t){return t*(Math.PI/180)}const k=linear().domain([v[0],v[2]]).range([0,d.width]),T=linear().domain([v[1],v[3]]).range(e?[0,d.width]:[d.height,0]),$=e?([t,e])=>{const n=transform(R.node());return[k(w(t))*n.k+n.x,T(_(e))*n.k+n.y]}:([t,e])=>{const n=transform(R.node());return[k(t)*n.k+n.x,T(e)*n.k+n.y]},F=e?([t,e])=>{const n=transform(R.node());return[b(k.invert((t-n.x)/n.k)),x(T.invert((e-n.y)/n.k))]}:([t,e])=>{const n=transform(R.node());return[k.invert((t-n.x)/n.k),T.invert((e-n.y)/n.k)]};function N(t,n){{const r=e?w(t[0]):t[0],o=Math.max(e?_(t[1]):t[1],e?_(t[3]):t[3]),i=e?w(t[2]):t[2],a=Math.min(e?_(t[1]):t[1],e?_(t[3]):t[3]),l=k.invert(0),s=Math.min(T.invert(0),T.invert(d.height)),c=(k.invert(d.width)-l)/(i-r),u=(Math.max(T.invert(0),T.invert(d.height))-s)/(o-a);let f;f=n?R.transition().duration(n):R,f.call(g.transform,identity.translate(k(r+(i-r)/2),T(a+(o-a)/2)).scale(Math.min(c,u)).translate(-k(r+(i-r)/2),-T(a+(o-a)/2)))}}const C=function(t,e){let n,r=0;const o=function(...o){const i=(new Date).getTime();i-r>=e?(r=i,t.apply(this,o)):(clearTimeout(n),n=setTimeout((()=>{r=i,t.apply(this,o)}),e-(i-r)))};return o.cancel=function(){clearTimeout(n)},o}((function(t){if(e&&"none"!=c?_drawSlippyMap({tileStore:y,ctx:m,transform:transform(R.node()),xMap:k,yMap:T,mercYToLat:x,mercXToLon:b,lonToMercX:w,latToMercY:_,coordToScreen:$,screenToCoord:F,tileWidth:o,greyscale:s,mapType:c}):m.clearRect(0,0,m.canvas.width,m.canvas.height),a)for(const e of a)e(p.node(),t)}),100),R=select(m.canvas);if(R.call(g),g.on("zoom",(t=>{u&&"mousemove"==t?.sourceEvent?.type&&u(t?.sourceEvent),f&&"mousemove"!=t?.sourceEvent?.type&&f(t?.sourceEvent),C.cancel(),C(t)})),R.call(g).on("dblclick.zoom",null),h||R.call(g).on(".zoom",null),p.node().addEventListener("mousemove",(t=>{C(t)})),p.node().tabIndex="0",p.node().addEventListener("keydown",(t=>{t.preventDefault(),"r"==t.key&&N(l,1e3)})),p.node().resetZoom=()=>(R.transition().duration(2e3).call(g.transform,identity),!0),p.node().screenToCoord=t=>F(t),p.node().coordToScreen=t=>$(t),p.node().zoomTo=t=>N(t),p.node().ctx=m,p.node().addInitFn=t=>{a?i.push(t):i=[t]},p.node().addDrawFn=t=>{a?a.push(t):a=[t]},p.node().getTransform=()=>transform(R.node()),p.node().redraw=()=>C(),p.node().setOnZoomFn=t=>{f=t},p.node().setOnPanFn=t=>u=t,p.node().getWidth=()=>n,p.node().getHeight=()=>r,p.node().getCoordExtent=()=>v,i)for(const t of i)t(p.node());return e&&l&&N(l),C(),p.node()}function _kernelSmooth(t){const e=t.grid,n=t.properties,r=t.propertyTypes;if(void 0===n||void 0===r)return void console.log("Need to define properties and propertyTypes for smoothing");const o=t.discretiser,i=t.kernelRadius,a=e.length+i,l=Math.max(...Object.values(e.map((t=>t.length))))+i;{const t=[];for(let n=-i;n<i;n++)for(let r=-i;r<i;r++){let a;if("grid"==e.type)a=Math.sqrt(Math.pow(n,2)+Math.pow(r,2));else if("hex"==e.type){const[t,e]=o.getXYCentreCellUnits(0,0),[i,l]=o.getXYCentreCellUnits(n,n<0?r:-r);a=Math.sqrt(Math.pow(t-i,2)+Math.pow(e-l,2))}if(a<i){var s=(i-a)/(i+a);t[n]||(t[n]=[]),t[n][r]=s}}for(let s=0;s<n.length;s++)for(let f=0;f<a;f++)for(let h=0;h<l;h++){let p,d=0;for(var c=-i;c<=i;c++)for(var u=-i;u<=i;u++)if(f+c>=0&&f+c<a&&h+u>=0&&h+u<l)if("value"===r[s]){let r,o=e[f+c]&&e[f+c][h+u]?e[f+c][h+u][n[s]]:0;isNaN(o)&&(o=0),r="hex"!=e.type||f%2!=0||c%2!=1&&c%2!=-1?t[c]?t[c][u]:0:t[c]?t[c][u+1]:0,r>0&&(p=p?p+o*r:o*r,d=d?d+r:r)}else if("array"===r[s]){let r,o=e[f+c]&&e[f+c][h+u]&&e[f+c][h+u][n[s]]?e[f+c][h+u][n[s]]:[];if(r="hex"!=e.type||f%2!=0||c%2!=1&&c%2!=-1?t[c]?t[c][u]:0:t[c]?t[c][u+1]:0,r>0){d=d?d+r:r;for(let t=0;t<o.length;t++){let e=o[t];e||(e=0),isNaN(e)&&(e=0),p||(p=[]),p[t]=void 0!==p[t]&&p[t]?p[t]+e*r:e*r}}}e[f]||(e[f]=[]);for(let t=0;t<n.length;t++)if("value"===r[t])p/d>0&&(e[f][h]||(e[f][h]={getBoundary:()=>o.getBoundary(f,h),getXCentre:()=>o.getXYCentre(f,h)[0]+e.xOffset,getYCentre:()=>o.getXYCentre(f,h)[1]+e.yOffset,getCellSize:()=>o.getCellSize(),new:!0}),e[f][h]["_"+n[t]]=p/d);else if("array"===r[t]&&p)for(let r=0;r<p.length;r++)p[r]/d>0&&(e[f][h]||(e[f][h]={getBoundary:()=>o.getBoundary(f,h),getXCentre:()=>o.getXYCentre(f,h)[0]+e.xOffset,getYCentre:()=>o.getXYCentre(f,h)[1]+e.yOffset,getCellSize:()=>o.getCellSize(),new:!0}),e[f][h]["_"+n[t]]||(e[f][h]["_"+n[t]]=[]),e[f][h]["_"+n[t]][r]=p[r]/d)}for(let t of e.flat())for(let e=0;e<n.length;e++)void 0!==t["_"+n[e]]&&(t[n[e]]=t["_"+n[e]])}}const heatmapGlyph=t=>{t||(t={});const e=t.colourScheme?t.colourScheme:sequential(Oranges),n=void 0===t.colourAutoscale||t.colourAutoscale,r=t.valueFn,o=t.normaliseValueFn,i=t.weightValueFn,a=t.type,l=void 0===t.useTransparency||t.useTransparency,s=void 0===t.showLegend||t.showLegend,c=t.numberFormatFn,u=t.initFn,f=t.preDrawFn,h=t.postDrawFn,p=t.aggrFn,d=t.postAggrFn,m=t.tooltipTextFn;return{scaleParams:[_setupParamFns({name:"colourMaxV",decKey:"LEFT",decFn:t=>t-t/10,incKey:"RIGHT",incFn:t=>t+t/10,resetKey:"s",autoscale:n,resetFn:(t,e,n)=>quantile(t.map((t=>t&&t.value?t.value:0)),.99)})],initFn:(t,e,n,r)=>{u&&u(t,e,n,r)},kernelSmoothProperties:["value"],kernelSmoothPropertyTypes:["value"],preAggrFn:t=>{},aggrFn:(t,e,n,l,s)=>{let c;if("count"!=a&&(c=r(e,l)??0*n??0),"mean"==a)t.value=t.value?t.value+(c||0):c,t.count=t.count?t.count+n:n;else if("sum"==a)t.value=t.value?t.value+(c||0):c,t.count=t.count?t.count+n:n;else if("weightedMean"==a){const r=i(e)*n??0;t.value=t.value?t.value+c*r:c*r,t.totalWeight=t.totalWeight?t.totalWeight+r:r}else"count"==a&&(t.value=t.count?t.count+n:n,t.count=t.value);if(t.count=t.count?t.count+n:n,o){const n=o(e)??0;t.denominator=t.denominator?t.denominator+n:n}p&&p(t,e,n,l,s)},postAggrFn:(t,e,n,r)=>{if("mean"==a)for(const e of t)e&&e.count&&(e.value=e.value/e.count);if("weightedMean"==a)for(const e of t)e&&e.count&&(e.value=e.value/e.totalWeight);if(o)for(const e of t)e.value=e.value/e.denominator??0;d&&d(t,e,n,r)},preDrawFn:(t,e,n,r,o)=>{f&&f(t,e,n,r,o),r.colourScale=linear().domain([0,r.colourMaxV]).range([0,1]).clamp(!0)},drawFn:(t,n,r,o,i,a,s)=>{if(t&&t.value){const n=t.getBoundary();i.fillStyle=e(a.colourScale(t.value)),l&&(i.globalAlpha=a.colourScale(t.value)),i.beginPath(),i.moveTo(n[0][0],n[0][1]);for(let t=1;t<n.length;t++)i.lineTo(n[t][0],n[t][1]);i.closePath(),i.fill()}},postDrawFn:(t,n,r,o,i)=>{s&&o.colourMaxV&&(_drawLegend({context:r,values:t.map((t=>t?t.value:NaN)),minV:0,maxV:o.colourMaxV,numBins:20,x:i.getWidth()-160,y:i.getHeight()-60,width:150,height:50,colourScale:e}),h&&h(t,n,r,o,i))},tooltipTextFn:t=>m?m(t):void 0!==t.value?c?c(t.value):t.value:""}};function glyphMap(options){const data=options.data,width=options.width?options.width:600,height=options.height?options.height:300,colourFieldFn=options.colourFieldFn?options.colourFieldFn:t=>t.value,type=options.type?options.type:"mean";let cellSize=options.cellSize?options.cellSize:5,discretisationMode=options.discretisationMode?options.discretisationMode:"relativeToScreen",discretisationShape=options.discretisationShape?options.discretisationShape:"grid",kernelBW=options.kernelBW,getLocationFn=options.getLocationFn?options.getLocationFn:t=>[t.lon,t.lat];const autoColourScale=options.autoColourScale,showLegend=!(!options.showLegend&&!1!==options.showLegend)&&options.showLegend;let colourMax;!options.useTransparency||options.useTransparency;const colourScale=options.colourScale?options.colourScale:sequential(YlGn);void 0===options.interactiveZoomPan||options.interactiveZoomPan;const interactiveColourScaling=options.interactiveColourScaling,interactiveCellSize=options.interactiveCellSize,interactiveKernelBW=options.interactiveKernelBW,drawSamplePoints=!!options.drawSamplePoints&&options.drawSamplePoints;let reduceMaup=void 0!==options.reduceMaup&&options.reduceMaup;if(!options.initialBB){const t=data.map(getLocationFn),e=extent(t.map((t=>+t[0]))),n=extent(t.map((t=>+t[1])));options.initialBB=[e[0],n[0],e[1],n[1]],console.log("initialBB",options.initialBB,e,n)}const discretiserFn=options.discretiserFn?options.discretiserFn:_generate2DHeatMap,useBlur=options.useBlur??!1;let kernelSmoothProperties,kernelSmoothPropertyTypes,alwaysReaggregate=!1,flags={reaggregate:!1},offSetMaupMode=void 0!==options.offSetMaupMode&&options.offSetMaupMode;const global={};let scaleParams,initFn,preAggrFn,aggrFn,postAggrFn,postKernelSmoothFn,preDrawFn,drawFn,postDrawFn,tooltipTextFn,showScaleParams=!1,discretiser;options.customMap&&(options.glyph=options.customMap),options.glyph?(options.glyph.kernelSmoothProperties&&(kernelSmoothProperties=options.glyph.kernelSmoothProperties),options.glyph.kernelSmoothPropertyTypes&&(kernelSmoothPropertyTypes=options.glyph.kernelSmoothPropertyTypes),scaleParams=options.glyph.scaleParams,initFn=options.glyph.initFn,preAggrFn=options.glyph.preAggrFn,aggrFn=options.glyph.aggrFn,postAggrFn=options.glyph.postAggrFn,postKernelSmoothFn=options.glyph.postKernelSmoothFn,preDrawFn=options.glyph.preDrawFn,drawFn=options.glyph.drawFn,postDrawFn=options.glyph.postDrawFn,tooltipTextFn=options.glyph.tooltipTextFn):"count"==type?aggrFn=(t,e,n)=>t.value=(t.value??0)+n:"sum"==type?aggrFn=(t,e,n)=>t.value=(t.value??0)+colourFieldFn(e)*n:"mean"==type&&(aggrFn=(t,e,n)=>{t.sum=(t.sum??0)+colourFieldFn(e)*n,t.count=(t.count??0)+1},postAggrFn=(t,e)=>{for(const e of t.flat())e&&e.count>0&&(e.value=e.sum/e.count)});const panel=slippyMap(options);let offSetCoordRef=[0,0];if(panel.setOnPanFn((t=>{offSetCoordRef=panel.screenToCoord([t.offsetX,t.offsetY])})),panel.setOnZoomFn((t=>{offSetCoordRef=panel.screenToCoord([t.offsetX,t.offsetY])})),panel.data=data,options.setup&&options.setup(panel,global),tooltipTextFn){const t=document.createElement("div");t.style.width="auto",t.style.height="auto",t.style.float="left",t.style.position="absolute",t.style.left="10px",t.style.top="10px",t.style.padding="2px",t.style.fontSize="10pt",t.style.backgroundColor="#dfd28977",t.style.pointerEvents="none",t.style.visibility="hidden",panel.appendChild(t),panel.addEventListener("mousemove",(e=>{const n=grid;if(grid&&discretiser){const[r,o]=discretiser.getColRow(e.offsetX-grid.xOffset,e.offsetY-grid.yOffset);r>0&&o>0&&r<n.length&&o<(n[r]?n[r].length:0)&&n[r]&&n[r][o]?(t.style.visibility="visible",t.innerHTML=tooltipTextFn(n[r][o],global,panel),t.style.left=e.offsetX+10+"px",t.style.top=e.offsetY+20+"px"):t.style.visibility="hidden"}}))}(interactiveColourScaling||interactiveCellSize)&&(panel.tabIndex="0",panel.addEventListener("keydown",(t=>{let e=!1;interactiveColourScaling&&37==t.keyCode&&(t.preventDefault(),colourMax+=colourMax/10,e=!0),interactiveColourScaling&&39==t.keyCode&&(t.preventDefault(),colourMax-colourMax/10>0&&(colourMax-=colourMax/10),e=!0),interactiveColourScaling&&"s"==t.key&&(t.preventDefault(),colourMax=void 0,e=!0),interactiveCellSize&&38==t.keyCode&&!t.shiftKey&&(t.preventDefault(),cellSize++,e=!0),interactiveCellSize&&40==t.keyCode&&!t.shiftKey&&(t.preventDefault(),cellSize--,e=!0),interactiveKernelBW&&38==t.keyCode&&t.shiftKey&&(t.preventDefault(),kernelBW++,e=!0),interactiveKernelBW&&40==t.keyCode&&t.shiftKey&&(t.preventDefault(),kernelBW--,e=!0),"m"==t.key&&(t.preventDefault(),reduceMaup=!reduceMaup,e=!0),"h"==t.key&&(t.preventDefault(),showScaleParams=!showScaleParams,e=!0),e&&panel.redraw()})));let grid=[],previousTransform,previousCellSize,previousKernelBW,previousMaupReduce;if(panel.redraw(),panel.setOptions=newOptions=>{for(const key of Object.keys(newOptions))"string"==typeof newOptions[key]?eval(key+'="'+newOptions[key]+'"'):eval(key+"="+newOptions[key]);flags.reaggregate=!0,panel.redraw()},panel.setData=t=>{panel.data=t,flags.reaggregate=!0,panel.redraw()},panel.setGlyph=t=>{t.kernelSmoothProperties&&(kernelSmoothProperties=t.kernelSmoothProperties),t.kernelSmoothPropertyTypes&&(kernelSmoothPropertyTypes=t.kernelSmoothPropertyTypes),t.scaleParams&&(scaleParams=t.scaleParams),t.initFn&&(initFn=t.initFn),t.preAggrFn&&(preAggrFn=t.preAggrFn),t.aggrFn&&(aggrFn=t.aggrFn),t.postAggrFn&&(postAggrFn=t.postAggrFn),t.postKernelSmoothFn&&(postKernelSmoothFn=t.postKernelSmoothFn),t.preDrawFn&&(preDrawFn=t.preDrawFn),t.drawFn&&(drawFn=t.drawFn),t.postDrawFn&&(postDrawFn=t.postDrawFn),t.tooltipTextFn&&(tooltipTextFn=t.tooltipTextFn),flags.reaggregate=!0,panel.redraw()},panel.getCoordBBInView=()=>{const t=panel.screenToCoord([0,height]),e=panel.screenToCoord([width,0]);return[t[0],t[1],e[0],e[1]]},panel.getCoordBB=panel.getCoordBBInView,panel.getDataInView=()=>{const t=panel.screenToCoord([0,height]),e=panel.screenToCoord([width,0]);return data.filter((n=>{const r=getLocationFn(n);return r[0]>=t[0]&&r[0]<=e[0]&&r[1]>=t[1]&&r[1]<=e[1]}))},panel.setAlwaysReaggregate=t=>{alwaysReaggregate=t},initFn&&initFn(grid.flat(),cellSize,global,panel),scaleParams)for(const t of scaleParams)t.initFn(grid.flat(),cellSize,global,panel);return panel.addEventListener("click",(t=>{if(showScaleParams){let e=0;console.log("click",t);for(const n of scaleParams)t.offsetY>10*e+5&&t.offsetY<10*(e+1)+5&&(n.getAutoscale()||(t.offsetX>5&&t.offsetX<15&&n.doDec(global,panel),t.offsetX>15&&t.offsetX<25&&n.doReset(global,panel),t.offsetX>25&&t.offsetX<35&&n.doInc(global,panel)),t.offsetX>35&&t.offsetX<45&&(n.toggleAutoscale(),panel.redraw())),e++}})),panel.addDrawFn((function(t,e){global.mouseX=e&&e.offsetX?e.offsetX:void 0,global.mouseY=e&&e.offsetY?e.offsetY:void 0;const n=panel.getTransform();if(flags.reaggregate||alwaysReaggregate||!previousTransform||previousTransform.x!=n.x||previousTransform.y!=n.y||previousTransform.z!=n.z||previousCellSize!==cellSize||previousKernelBW!==kernelBW||previousMaupReduce!==reduceMaup){if(flags.reaggregate=!1,!discretiser||previousCellSize!=cellSize)if("grid"==discretisationShape)discretiser=_getGridDiscretiser(cellSize);else{if("hex"!=discretisationShape)return"Invalid discretisationShape";discretiser=_getHexDiscretiser(cellSize)}if(global.discretiser=discretiser,scaleParams)for(const t of scaleParams)t.preAggrFn&&t.preAggrFn(grid.flat(),cellSize,panel.ctx,global,panel);grid=discretiserFn({data:panel.data,width:width,height:height,getLocationFn:getLocationFn,coordToScreenFn:t=>panel.coordToScreen(t),screenToCoordFn:t=>panel.screenToCoord(t),cellSize:cellSize,discretiser:discretiser,preAggrFn:preAggrFn,global:global,aggrFn:aggrFn,postAggrFn:postAggrFn,getLocationFn:getLocationFn,offSetCoordRef:offSetCoordRef,discretisationMode:discretisationMode,reduceMaup:reduceMaup,panel:panel,offSetMaupMode:offSetMaupMode}),previousTransform=n,previousCellSize=cellSize,previousKernelBW=kernelBW,previousMaupReduce=reduceMaup,kernelBW&&kernelBW>0&&(useBlur?_blur({grid:grid,properties:kernelSmoothProperties,propertyTypes:kernelSmoothPropertyTypes,discretiser:discretiser,kernelRadius:Math.trunc(kernelBW/2)}):_kernelSmooth({grid:grid,properties:kernelSmoothProperties,propertyTypes:kernelSmoothPropertyTypes,discretiser:discretiser,kernelRadius:kernelBW}))}if(global.mouseX&&global.mouseY){const[t,e]=discretiser.getColRow(global.mouseX-grid.xOffset,global.mouseY-grid.yOffset);t>0&&e>0&&t<grid.length&&e<(grid[t]?grid[t].length:0)&&grid[t]&&grid[t][e]?global.mouseCell=grid[t][e]:global.mouseCell=void 0}else global.mouseCell=void 0;if(postKernelSmoothFn&&postKernelSmoothFn(grid.flat(),cellSize,global,panel),!autoColourScale&&colourMax||(colourMax=max(grid.flat(),(t=>t&&t.value?t.value:NaN)),colourMax||(colourMax=0)),scaleParams)for(const t of scaleParams)t.preDrawFn&&(panel.ctx.save(),t.preDrawFn(grid.flat(),cellSize,panel.ctx,global,panel),panel.ctx.restore());if(preDrawFn&&(panel.ctx.save(),preDrawFn(grid.flat(),cellSize,panel.ctx,global,panel),panel.ctx.restore()),drawFn){panel.ctx.save();for(const t of grid.flat())drawFn(t,t.getXCentre()+grid.xOffset??0,t.getYCentre()+grid.yOffset??0,cellSize,panel.ctx,global,panel);panel.ctx.restore()}if(drawSamplePoints)for(let t of data){const e=panel.coordToScreen(getLocationFn(t));panel.ctx.fillStyle="#000",panel.ctx.fillRect(e[0],e[1],2,2)}if(postDrawFn&&(panel.ctx.save(),postDrawFn(grid.flat(),cellSize,panel.ctx,global,panel),panel.ctx.restore()),scaleParams&&showScaleParams){const t=[];for(const e of scaleParams){let n=e.name+": "+e.numberFormatFn(global[e.name]);(e.decKey||e.incKey||e.resetKey)&&(n+=" ("+(e.decKey?e.decKey:"<none>")+"/"+(e.incKey?e.incKey:"<none>")+"/"+(e.resetKey?e.resetKey:"<none>")+")"),t.push(n)}const e=40+max(t.map((t=>panel.ctx.measureText(t).width)))+5;panel.ctx.fillStyle="#fff",panel.ctx.fillRect(0,0,e,10*scaleParams.length+5+5);let n=0;panel.ctx.font="10px",panel.ctx.textBaseline="top";for(const e of scaleParams)panel.ctx.fillStyle="#aaa",panel.ctx.strokeStyle="#aaa",e.getAutoscale()||(panel.ctx.fillRect(5,10*n+5+1,9,8),panel.ctx.fillRect(15,10*n+5+1,9,8),panel.ctx.fillRect(25,10*n+5+1,9,8)),e.getAutoscale()?panel.ctx.fillRect(35,10*n+5+1,9,8):panel.ctx.strokeRect(35,10*n+5+1,9,8),panel.ctx.fillStyle="#333",panel.ctx.textAlign="center",e.getAutoscale()||(panel.ctx.fillText("<",10,10*n+5),panel.ctx.fillText(">",30,10*n+5)),panel.ctx.fillText("A",40,10*n+5),panel.ctx.fillStyle="#333",panel.ctx.textAlign="left",panel.ctx.fillText(t[n],50,10*n+5),n++}showLegend&&_drawLegend({context:panel.ctx,values:grid.flat().map((t=>t?t.value:NaN)),minV:0,maxV:colourMax,numBins:20,x:width-160,y:height-60,width:150,height:50,colourScale:colourScale})})),panel}export{_blur,_drawCellBackground,_drawLegend,_generate2DHeatMap,_getGridDiscretiser,_getHexDiscretiser,_kernelSmooth,_setupParamFns,glyphMap,heatmapGlyph,slippyMap};
